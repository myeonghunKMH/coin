<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Í≥ºÍ±∞ Îç∞Ïù¥ÌÑ∞ Î™®ÏùòÌà¨Ïûê</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.2.1/dist/chartjs-chart-financial.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0f1419;
            color: #ffffff;
            overflow-x: hidden;
        }

        .header {
            background: #1a1f2e;
            padding: 15px 20px;
            border-bottom: 1px solid #2d3748;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #00d4aa;
        }

        .balance-info {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .balance-item {
            text-align: center;
        }

        .balance-label {
            font-size: 12px;
            color: #8892b0;
            margin-bottom: 2px;
        }

        .balance-value {
            font-size: 16px;
            font-weight: bold;
            color: #00d4aa;
        }

        .main-container {
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            height: calc(100vh - 70px);
            gap: 1px;
            background: #2d3748;
        }

        .left-panel {
            background: #1a1f2e;
            display: flex;
            flex-direction: column;
        }

        .market-select {
            padding: 20px;
            border-bottom: 1px solid #2d3748;
        }

        .market-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .market-tab {
            padding: 8px 15px;
            background: #2d3748;
            border: none;
            color: #8892b0;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
        }

        .market-tab.active {
            background: #00d4aa;
            color: #1a1f2e;
        }

        .market-list {
            flex: 1;
            overflow-y: auto;
        }

        .market-item {
            padding: 12px 20px;
            border-bottom: 1px solid #2d3748;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .market-item:hover {
            background: #2d3748;
        }

        .market-item.active {
            background: #00d4aa;
            color: #1a1f2e;
        }

        .market-name {
            font-weight: bold;
            margin-bottom: 2px;
        }

        .market-price {
            font-size: 14px;
            font-weight: bold;
        }

        .price-change {
            font-size: 12px;
        }

        .price-up {
            color: #d73527;
        }

        .price-down {
            color: #1261c4;
        }

        .center-panel {
            background: #1a1f2e;
            display: flex;
            flex-direction: column;
        }

        .chart-header {
            padding: 20px;
            border-bottom: 1px solid #2d3748;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .current-price {
            font-size: 28px;
            font-weight: bold;
            color: #ffffff;
        }

        .price-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .simulation-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .control-btn {
            padding: 8px 15px;
            background: #2d3748;
            border: none;
            color: #ffffff;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .control-btn:hover {
            background: #4a5568;
        }

        .control-btn.active {
            background: #00d4aa;
            color: #1a1f2e;
        }

        .speed-control {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .speed-slider {
            width: 100px;
        }

        .chart-container {
            flex: 1;
            padding: 20px;
            position: relative;
        }
 
        #priceChart {
            width: 100%;
            height: 100%;
        }

        .right-panel {
            background: #1a1f2e;
            display: flex;
            flex-direction: column;
        }

        .trading-section {
            flex: 1;
            padding: 20px;
        }

        .trading-tabs {
            display: flex;
            margin-bottom: 20px;
        }

        .trading-tab {
            flex: 1;
            padding: 12px;
            background: #2d3748;
            border: none;
            color: #8892b0;
            cursor: pointer;
            font-size: 14px;
        }

        .trading-tab.active {
            background: #00d4aa;
            color: #1a1f2e;
        }

        .trading-tab.buy {
            border-radius: 4px 0 0 4px;
        }

        .trading-tab.sell {
            border-radius: 0 4px 4px 0;
        }

        .order-form {
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #8892b0;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            background: #2d3748;
            border: 1px solid #4a5568;
            border-radius: 4px;
            color: #ffffff;
            font-size: 14px;
        }

        .form-input:focus {
            outline: none;
            border-color: #00d4aa;
        }
        
        .percentage-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            align-items: center;
        }
        .percentage-buttons {
            display: flex;
            gap: 5px;
            flex-grow: 1;
        }
        .percentage-btn {
            padding: 8px;
            background: #2d3748;
            border: 1px solid #4a5568;
            color: #8892b0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            flex: 1;
        }
        .percentage-btn:hover {
            background: #4a5568;
        }
        .percentage-input-group {
            display: flex;
            align-items: center;
            background: #2d3748;
            border: 1px solid #4a5568;
            border-radius: 4px;
            padding: 0 10px 0 0;
        }
        
        .percentage-input {
            width: 70px;
            height: 35px;
            padding: 8px;
            border: none;
            background: transparent;
            text-align: right;
            color: #ffffff;
            font-size: 12px;
            -moz-appearance: textfield;
        }
        .percentage-input::-webkit-outer-spin-button,
        .percentage-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .order-btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
        }

        .buy-btn {
            background: #d73527;
            color: #ffffff;
        }

        .sell-btn {
            background: #1261c4;
            color: #ffffff;
        }

        .order-btn:hover {
            opacity: 0.9;
        }

        .order-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .holdings-section {
            border-top: 1px solid #2d3748;
            padding: 20px;
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .holdings-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #ffffff;
            padding-bottom: 10px;
            border-bottom: 1px solid #2d3748;
        }
        
        #holdingsList {
            flex: 1;
            overflow-y: auto;
        }

        .holding-item {
            display: grid;
            grid-template-columns: 1fr 2fr;
            padding: 12px 5px;
            border-bottom: 1px solid #2d3748;
            font-size: 14px;
        }
        .holding-item:last-child {
            border-bottom: none;
        }
        .holding-symbol {
            font-weight: bold;
            color: #ffffff;
            font-size: 16px;
            margin-bottom: 5px;
        }
        .holding-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2px 10px;
            font-size: 12px;
        }
        .detail-label {
            color: #8892b0;
        }
        .detail-value {
            text-align: right;
            font-weight: bold;
        }
        .holding-pnl {
            font-size: 12px;
            text-align: right;
        }
        .positive {
            color: #d73527;
        }
        .negative {
            color: #1261c4;
        }

        .time-display {
            padding: 10px 20px;
            background: #2d3748;
            text-align: center;
            font-family: monospace;
            font-size: 16px;
            color: #00d4aa;
        }

        .status-bar {
            padding: 10px 20px;
            background: #2d3748;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #00d4aa;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #1a1f2e;
            border-radius: 8px;
            padding: 30px;
            min-width: 400px;
            border: 1px solid #2d3748;
        }

        .modal-header {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #ffffff;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            color: #8892b0;
            font-size: 24px;
            cursor: pointer;
        }

        .order-summary {
            background: #2d3748;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .confirm-btn {
            width: 100%;
            padding: 15px;
            background: #00d4aa;
            color: #1a1f2e;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }

        .error-message {
            color: #e53e3e;
            background: rgba(229, 62, 62, 0.1);
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 250px 1fr 300px;
            }
        }

        @media (max-width: 900px) {
            .main-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr auto;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">Í≥ºÍ±∞ Îç∞Ïù¥ÌÑ∞ Í∞ÄÏÉÅÌôîÌèê Î™®ÏùòÌà¨Ïûê</div>
        <div class="balance-info">
            <div class="balance-item">
                <div class="balance-label">Î≥¥Ïú† KRW</div>
                <div class="balance-value" id="krwBalance">1,000,000</div>
            </div>
            <div class="balance-item">
                <div class="balance-label">Ï¥ù ÏûêÏÇ∞</div>
                <div class="balance-value" id="totalAssets">1,000,000</div>
            </div>
            <div class="balance-item">
                <div class="balance-label">ÏàòÏùµÎ•†</div>
                <div class="balance-value" id="profitRate">0.00%</div>
            </div>
        </div>
    </div>

    <div class="main-container">
        <div class="left-panel">
            <div class="market-select">
                <div class="market-tabs">
                    <button onclick="history.back()" class="market-tab active">Ïù¥Ï†Ñ ÌéòÏù¥ÏßÄ</button>  
                </div>
            </div>
            <div class="market-list">
                <div class="market-item active" data-market="btc">
                    <div>
                        <div class="market-name">BTC/KRW</div>
                        <div class="market-price" id="btc-price">-</div>
                    </div>
                    <div class="price-change" id="btc-change">-</div>
                </div>
            </div>
            <div class="news-section" style="border-top:1px solid #2d3748; padding:15px 10px; overflow-y:auto; flex:4;">
                <div class="news-title" style="font-weight:bold; margin-bottom:10px;">Îâ¥Ïä§ ÌÉÄÏûÑÎùºÏù∏</div>
                <div id="news-timeline" class="news-list" style="max-height:600px; overflow-y:auto;"></div>
            </div>
        </div>

        <div class="center-panel">
            <div class="chart-header">
                <div class="price-info">
                    <div class="current-price" id="currentPrice">-</div>
                    <div id="priceChange">-</div>
                </div>
                <div class="simulation-controls">
                    <button class="control-btn" id="playBtn">‚ñ∂Ô∏è ÏãúÏûë</button>
                    <button class="control-btn" id="pauseBtn">‚è∏Ô∏è ÏùºÏãúÏ†ïÏßÄ</button>
                    <button class="control-btn" id="resetBtn">üîÑ Î¶¨ÏÖã</button>
                    <div class="speed-control">
                        <span>ÏÜçÎèÑ:</span>
                        <input type="range" class="speed-slider" id="speedSlider" min="1" max="10" value="1">
                        <span id="speedDisplay">1x</span>
                    </div>
                </div>
            </div>
            <div class="time-display" id="timeDisplay">
                ÏãúÎÆ¨Î†àÏù¥ÏÖò ÏãúÍ∞Ñ: Ï§ÄÎπÑ Ï§ë...
            </div>
            <div class="chart-container">
                <canvas id="priceChart"></canvas>
            </div>
            <div class="status-bar">
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span id="statusText">ÏãúÎÆ¨Î†àÏù¥ÏÖò ÎåÄÍ∏∞ Ï§ë</span>
                </div>
                <div id="dataProgress">Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ï§ë...</div>
            </div>
        </div>

        <div class="right-panel">
            <div class="trading-section">
                <div class="trading-tabs">
                    <button class="trading-tab buy active" id="buyTab">Îß§Ïàò</button>
                    <button class="trading-tab sell" id="sellTab">Îß§ÎèÑ</button>
                </div>

                <div class="order-form" id="orderForm">
                    <div class="form-group">
                        <label class="form-label">Ï£ºÎ¨∏ ÏàòÎüâ</label>
                        <input type="number" class="form-input" id="orderAmount" placeholder="0" step="0.00000001">
                        <div class="percentage-controls">
                            <div class="percentage-buttons">
                                <button class="percentage-btn" data-percent="25">25%</button>
                                <button class="percentage-btn" data-percent="50">50%</button>
                                <button class="percentage-btn" data-percent="75">75%</button>
                                <button class="percentage-btn" data-percent="100">MAX</button>
                            </div>
                            <div class="percentage-input-group">
                                <input type="number" id="percentageInput" class="percentage-input" placeholder="ÏßÅÏ†ëÏûÖÎ†•">
                                <span>%</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Ï£ºÎ¨∏ Í∞ÄÍ≤©</label>
                        <input type="number" class="form-input" id="orderPrice" placeholder="ÏãúÏû•Í∞Ä">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Ï£ºÎ¨∏ Ï¥ùÏï°</label>
                        <input type="number" class="form-input" id="orderTotal" placeholder="0" readonly>
                    </div>

                    <button class="order-btn buy-btn" id="orderBtn">Îß§Ïàò</button>
                </div>

                <div id="errorMessage" class="error-message" style="display: none;"></div>
            </div>

            <div class="holdings-section">
                <div class="holdings-title">Î≥¥Ïú† ÏûêÏÇ∞</div>
                <div id="holdingsList">
                    </div>
            </div>
        </div>
    </div>

    <div class="modal" id="orderModal">
        <div class="modal-content">
            <button class="close-btn" id="closeModal">&times;</button>
            <div class="modal-header">Ï£ºÎ¨∏ ÌôïÏù∏</div>
            <div class="order-summary" id="orderSummary">
                </div>
            <button class="confirm-btn" id="confirmOrder">Ï£ºÎ¨∏ ÌôïÏù∏</button>
        </div>
    </div>
    <div class="modal" id="resultsModal">
        <div class="modal-content">
            <div class="modal-header">üèÜ ÏãúÎÆ¨Î†àÏù¥ÏÖò Í≤∞Í≥º</div>
            <div class="order-summary" id="resultsSummary">
                <div class="summary-row">
                    <span>Ï¥ù ÏûêÏÇ∞</span>
                    <span id="finalAssets"></span>
                </div>
                <div class="summary-row">
                    <span>Ï¥ù ÏÜêÏùµ</span>
                    <span id="finalPnl"></span>
                </div>
                <div class="summary-row">
                    <span>ÏàòÏùµÎ•†</span>
                    <span id="finalPnlRate"></span>
                </div>
            </div>
            <button class="confirm-btn" id="closeResultsModal">ÌôïÏù∏</button>
        </div>
    </div>

    <div id="overlay"
        style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); z-index:1500;">
    </div>
    <div id="news-popup" style="display:none; position:fixed; top:20%; left:50%; transform:translate(-50%,-20%);
                background:#1a1f2e; border:1px solid #444; padding:25px; border-radius:8px;
                z-index:2000; text-align:left; width:600px; max-height:70vh; overflow-y:auto;">
    
        <h3 id="news-popup-title" style="margin-bottom:10px; font-size:1.4rem;"></h3>
        <div id="news-popup-date" style="font-size:0.9rem; color:#bbb; margin-bottom:15px;"></div>
        <p id="news-popup-desc" style="margin:10px 0; line-height:1.5; white-space:pre-line;"></p>
    
        <!-- 1Îã®Í≥Ñ: ÏÑ†ÌÉù Î≤ÑÌäº (Ìï≠ÏÉÅ Î≥¥ÏûÑ, Í∏∞Ï°¥ Ïä§ÌÉÄÏùº Î≥µÏõê) -->
        <div id="news-popup-choice" style="display:flex; gap:10px; margin-top:15px;">
            <button id="news-popup-buy" style="flex:1; padding:12px; background:#d73527; border:none; border-radius:5px;
                       cursor:pointer; color:#fff; font-weight:bold;">Îß§Ïàò</button>
            <button id="news-popup-sell" style="flex:1; padding:12px; background:#1261c4; border:none; border-radius:5px;
                       cursor:pointer; color:#fff; font-weight:bold;">Îß§ÎèÑ</button>
            <button id="news-popup-hold" style="flex:1; padding:12px; background:#444; border:none; border-radius:5px;
                       cursor:pointer; color:#fff; font-weight:bold;">Ïú†ÏßÄ</button>
        </div>
    
        <!-- 2Îã®Í≥Ñ: Ïã§Ï†ú Ï£ºÎ¨∏Ï∞Ω (Î≤ÑÌäºÏùÄ Í∑∏ÎåÄÎ°ú ÎëêÍ≥†, Ï£ºÎ¨∏Ï∞ΩÎßå Ï∂îÍ∞ÄÎ°ú ÎÖ∏Ï∂úÎê®) -->
        <div id="news-trade-form" style="display:none; margin-top:20px;">
            <div class="form-group">
                <label class="form-label">Ï£ºÎ¨∏ ÏàòÎüâ</label>
                <input type="number" class="form-input" id="news-orderAmount" placeholder="0" step="0.00000001">
                <div class="percentage-controls">
                    <div class="percentage-buttons">
                        <button class="percentage-btn" data-percent="25">25%</button>
                        <button class="percentage-btn" data-percent="50">50%</button>
                        <button class="percentage-btn" data-percent="75">75%</button>
                        <button class="percentage-btn" data-percent="100">MAX</button>
                    </div>
                    <div class="percentage-input-group">
                        <input type="number" id="news-percentageInput" class="percentage-input" placeholder="ÏßÅÏ†ëÏûÖÎ†•">
                        <span>%</span>
                    </div>
                </div>
            </div>
        
            <div class="form-group">
                <label class="form-label">Ï£ºÎ¨∏ Í∞ÄÍ≤©</label>
                <input type="number" class="form-input" id="news-orderPrice" placeholder="ÏãúÏû•Í∞Ä">
            </div>
        
            <div class="form-group">
                <label class="form-label">Ï£ºÎ¨∏ Ï¥ùÏï°</label>
                <input type="number" class="form-input" id="news-orderTotal" placeholder="0" readonly>
            </div>
        
            <!-- Îß§Ïàò/Îß§ÎèÑÏóê Îî∞Îùº ÎèôÏ†ÅÏúºÎ°ú ÌÅ¥ÎûòÏä§ Î≥ÄÍ≤Ω -->
            <button id="news-orderConfirm" class="order-btn buy-btn">Îß§Ïàò</button>
        </div>
    </div>

    <script>
    class HistoricalTradingSystem {
        constructor() {
            this.currentMarket = 'btc';
            this.isBuyMode = true;
            this.isSimulationRunning = false;
            this.simulationSpeed = 3;
            this.currentDataIndex = 0;
            this.startIndex = 0; // üîπ ÏãúÎÆ¨Î†àÏù¥ÏÖò ÏãúÏûë Ïù∏Îç±Ïä§
            this.historicalData = {};
            this.chart = null; 
            
            this.initialKrw = 10000000;
            this.portfolio = {
                krw: this.initialKrw,
                btc: { amount: 0, totalCost: 0 },
                eth: { amount: 0, totalCost: 0 },
                xrp: { amount: 0, totalCost: 0 }
            };
            
            this.currentPrices = { btc: 0, eth: 0, xrp: 0 };
            this.tradeHistory = [];
            this.newsList = [];

            this.init();
        }

        async init() {
            this.setupEventListeners();
            await this.loadHistoricalData();
            await this.loadNews();

            // üîπ Ï¥àÍ∏∞ Ìïú Îã¨ Íµ¨Í∞Ñ (2021-03-25 ~ 2021-04-25) ÎØ∏Î¶¨ ÌëúÏãú
            const preloadEnd = new Date("2021-04-25T23:59:59+09:00").getTime();
            const data = this.historicalData[this.currentMarket];

            // preloadIndex = Ìïú Îã¨ Ïπò ÎßàÏßÄÎßâ Îç∞Ïù¥ÌÑ∞ Ïù∏Îç±Ïä§
            let preloadIndex = data.findIndex(d => d.timestamp >= preloadEnd);
            if (preloadIndex === -1) preloadIndex = 0;

            // ‚úÖ Ï∞®Ìä∏ÏóêÎäî preloadIndexÍπåÏßÄ Î®ºÏ†Ä Í∑∏Î¶¨Í∏∞
            this.currentDataIndex = preloadIndex;

            // üîπ ÏãúÎÆ¨Î†àÏù¥ÏÖò ÏãúÏûëÏùºÏûê (2021-04-26 Ïù¥ÌõÑ Îç∞Ïù¥ÌÑ∞Î∂ÄÌÑ∞ ÏßÑÌñâ)
            this.startIndex = preloadIndex;

            this.initChart();
            this.updateDisplay();

            // ‚úÖ Ï¥àÍ∏∞ ÌëúÏãú Íµ¨Í∞Ñ Ï¶âÏãú Î∞òÏòÅ
            this.updateMarketPrices();   // Í∞ÄÍ≤©/Î≥ÄÎèôÎ•† ÏóÖÎç∞Ïù¥Ìä∏
            this.updateChart();          // Ï∞®Ìä∏ Í∞±Ïã†
            document.getElementById('speedSlider').value = this.simulationSpeed;
            document.getElementById('speedDisplay').textContent = `${this.simulationSpeed}x`;
        }
        
        async loadNews() {
            try {
                const res = await fetch("/api/scenario1/news");
                this.newsList = await res.json();
                document.getElementById("news-timeline").innerHTML = "";
            } catch (err) {
                console.error("Îâ¥Ïä§ Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®:", err);
                this.newsList = [];
            }
        }

        setupEventListeners() {
            document.querySelectorAll('.market-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    document.querySelectorAll('.market-item').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    this.currentMarket = item.dataset.market;
                    this.updateDisplay();
                });
            });

            document.getElementById('percentageInput').addEventListener('input', (e) => {
                const percentValue = parseFloat(e.target.value);
                if (!isNaN(percentValue) && percentValue >= 0) {
                    this.setOrderAmount(percentValue > 100 ? 100 : percentValue);
                }
            });

            document.getElementById('buyTab').addEventListener('click', () => this.switchTradingMode(true));
            document.getElementById('sellTab').addEventListener('click', () => this.switchTradingMode(false));
            document.getElementById('playBtn').addEventListener('click', () => this.startSimulation());
            document.getElementById('pauseBtn').addEventListener('click', () => this.pauseSimulation());
            document.getElementById('resetBtn').addEventListener('click', () => this.resetSimulation());
            document.getElementById('speedSlider').addEventListener('input', (e) => {
                this.simulationSpeed = parseInt(e.target.value);
                document.getElementById('speedDisplay').textContent = `${this.simulationSpeed}x`;
                if (this.isSimulationRunning) {
                    this.pauseSimulation();
                    this.startSimulation();
                }
            });
            document.querySelectorAll('.percentage-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const percent = parseInt(e.target.dataset.percent);
                    this.setOrderAmount(percent);
                });
            });
            document.getElementById('orderAmount').addEventListener('input', () => this.calculateOrderTotal());
            document.getElementById('orderPrice').addEventListener('input', () => this.calculateOrderTotal());
            document.getElementById('orderBtn').addEventListener('click', () => this.showOrderModal());
            document.getElementById('closeModal').addEventListener('click', () => this.hideOrderModal());
            document.getElementById('confirmOrder').addEventListener('click', () => this.executeOrder());
            document.getElementById('closeResultsModal').addEventListener('click', () => {
                document.getElementById('resultsModal').style.display = 'none';
            });
        }

        async loadHistoricalData() {
            try {
                document.getElementById('dataProgress').textContent = 'ÏÑúÎ≤Ñ Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ï§ë...';

                const markets = ['btc'];   // ‚úÖ BTCÎßå ÏÇ¨Ïö©
                let loadedCount = 0;

                for (const market of markets) {
                    try {
                        const response = await fetch(`/api/history?market=${market}&limit=10000`);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const data = await response.json();

                        this.historicalData[market] = data.map(item => ({
                            candle_date_time_kst: item.candle_date_time_kst,
                            timestamp: new Date(item.candle_date_time_kst).getTime(),
                            opening_price: parseFloat(item.opening_price),
                            high_price: parseFloat(item.high_price),
                            low_price: parseFloat(item.low_price),
                            trade_price: parseFloat(item.trade_price),
                            volume: parseFloat(item.volume || 0)
                        }));

                        loadedCount++;
                        document.getElementById('dataProgress').textContent =
                            `Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ï§ë... (${loadedCount}/${markets.length})`;

                    } catch (error) {
                        console.error(`${market.toUpperCase()} Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ïã§Ìå®:`, error);
                        this.historicalData[market] = [];
                    }
                }

                const totalDataCount = Object.values(this.historicalData)
                    .reduce((sum, data) => sum + data.length, 0);

                if (totalDataCount > 0) {
                    document.getElementById('dataProgress').textContent =
                        `Îç∞Ïù¥ÌÑ∞ Î°úÎî© ÏôÑÎ£å (Ï¥ù ${totalDataCount}Í∞ú Î†àÏΩîÎìú)`;
                } else {
                    document.getElementById('dataProgress').textContent = 'Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ïã§Ìå®';
                }

            } catch (error) {
                console.error('Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ïã§Ìå®:', error);
                document.getElementById('dataProgress').textContent = 'Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ïã§Ìå®';
            }
        }

        initChart() {
            if(this.chart) this.chart.destroy();
            const ctx = document.getElementById('priceChart').getContext('2d');
            this.chart = new Chart(ctx, {
                type: 'candlestick', 
                data: {
                    datasets: [
                        {
                            type: 'candlestick',
                            label: 'Price',
                            data: [],
                            yAxisID: 'yPrice',
                            color: {
                                up: 'rgba(215, 53, 39, 0.8)',
                                down: 'rgba(18, 97, 196, 0.8)',
                                unchanged: '#999'
                            }          
                        },
                        {
                            type: 'bar',
                            label: 'Volume',
                            data: [],
                            yAxisID: 'yVolume',
                        }
                    ],
                },
                options: {
                    animation: false,
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day',   // üîπ ÏùºÎ¥â Îç∞Ïù¥ÌÑ∞ÎãàÍπå dayÎ°ú Î≥ÄÍ≤Ω
                                tooltipFormat: 'yyyy-MM-dd',
                                displayFormats: { day: 'MM-dd' }
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)', borderColor: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#8892b0', maxRotation: 0, autoSkip: true, maxTicksLimit: 10 }
                        },
                        yVolume: {
                            type: 'linear',
                            position: 'left',
                            stack: 'stock_chart',
                            stackWeight: 1,
                            grid: { drawOnChartArea: false,
                                borderColor: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { display: false }
                        },
                        yPrice: {
                            type: 'linear',
                            position: 'left',
                            stack: 'stock_chart',
                            stackWeight: 4,
                            grid: { color: 'rgba(255, 255, 255, 0.1)',
                                borderColor: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#8892b0' }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: { mode: 'index', intersect: false }
                    }
                }
            });
        }

        updateChart() {
            if (!this.chart || !this.historicalData[this.currentMarket]) return;

            const slicedData = this.historicalData[this.currentMarket].slice(0, this.currentDataIndex + 1);
            const displayData = slicedData.slice(-70);

            // ‚úÖ Ï∫îÎì§ Îç∞Ïù¥ÌÑ∞ (Î™∏ÌÜµ ÌëúÏãú)
            const priceData = displayData.map(d => {
                const isUp = parseFloat(d.trade_price) >= parseFloat(d.opening_price);
                const candleColor = isUp ? 'rgba(215, 53, 39, 0.8)' : 'rgba(18, 97, 196, 0.8)'; // Í±∞ÎûòÎüâ ÏÉâÍ≥º ÎßûÏ∂§
                return {
                    x: new Date(d.candle_date_time_kst).getTime(),
                    o: parseFloat(d.opening_price),
                    h: parseFloat(d.high_price),
                    l: parseFloat(d.low_price),
                    c: parseFloat(d.trade_price),
                    color: candleColor   // üîπ Ï∫îÎì§Î≥Ñ ÏÉâÏÉÅ ÏßÄÏ†ï
                };
            });

            // ‚úÖ Í±∞ÎûòÎüâ Îç∞Ïù¥ÌÑ∞
            const volumeData = displayData.map(d => ({
                x: new Date(d.candle_date_time_kst).getTime(),
                y: parseFloat(d.volume || 0),
            }));

            // ‚úÖ Í±∞ÎûòÎüâ ÏÉâÏÉÅ (ÏÉÅÏäπ = Îπ®Í∞ï, ÌïòÎùΩ = ÌååÎûë)
            const volumeColors = displayData.map(d =>
                parseFloat(d.trade_price) >= parseFloat(d.opening_price)
                    ? 'rgba(215, 53, 39, 0.5)'   // ÏÉÅÏäπ ‚Üí Îπ®Í∞ï
                    : 'rgba(18, 97, 196, 0.5)'   // ÌïòÎùΩ ‚Üí ÌååÎûë
            );

            // Ï∞®Ìä∏ Îç∞Ïù¥ÌÑ∞ Í∞±Ïã†
            this.chart.data.datasets[0].data = priceData;   // Ï∫îÎì§
            this.chart.data.datasets[1].data = volumeData;  // Í±∞ÎûòÎüâ
            this.chart.data.datasets[1].backgroundColor = volumeColors;

            this.chart.update('none');
        }

        updateMarketPrices() {
            Object.keys(this.historicalData).forEach(market => {
                if (this.historicalData[market] && this.historicalData[market].length > 0) {
                    const currentData = this.historicalData[market][this.currentDataIndex] || this.historicalData[market][0];
                    const prevData = this.historicalData[market][this.currentDataIndex - 1] || currentData;
                    
                    const price = parseFloat(currentData.trade_price);
                    const prevPrice = parseFloat(prevData.trade_price);
                    const change = ((price - prevPrice) / prevPrice * 100).toFixed(2);
                    
                    this.currentPrices[market] = price;
                    
                    const priceElement = document.getElementById(`${market}-price`);
                    const changeElement = document.getElementById(`${market}-change`);
                    
                    if (priceElement) {
                        priceElement.textContent = price.toLocaleString();
                    }
                    
                    if (changeElement) {
                        changeElement.textContent = `${change > 0 ? '+' : ''}${change}%`;
                        changeElement.className = `price-change ${change >= 0 ? 'price-up' : 'price-down'}`;
                    }
                }
            });
            
            this.updateDisplay();
        }

        updateCurrentMarketDisplay() {
            const currentData = this.historicalData[this.currentMarket]?.[this.currentDataIndex];
            if (!currentData) return;

            const price = parseFloat(currentData.trade_price);
            const prevData = this.historicalData[this.currentMarket]?.[this.currentDataIndex - 1];
            
            document.getElementById('currentPrice').textContent = price.toLocaleString() + ' KRW';
            
            if (prevData) {
                const prevPrice = parseFloat(prevData.trade_price);
                const change = price - prevPrice;
                const changePercent = ((change / prevPrice) * 100).toFixed(2);
                
                const changeElement = document.getElementById('priceChange');
                changeElement.textContent = `${change >= 0 ? '+' : ''}${change.toLocaleString()} (${changePercent}%)`;
                changeElement.className = change >= 0 ? 'positive' : 'negative';
            }

            if (currentData.candle_date_time_kst) {
                const date = new Date(currentData.candle_date_time_kst);
                // KSTÎ°ú Î≥ÄÌôò ÌõÑ Ï¥à Ï†úÍ±∞
                const kstString = date.toLocaleString("ko-KR", {
                    timeZone: "Asia/Seoul",
                    year: "numeric",
                    month: "2-digit",
                    day: "2-digit",
                    hour: "2-digit",
                    minute: "2-digit"
                }).replace(/\s/g, ''); // Í≥µÎ∞± Ï†úÍ±∞ (2021.05.19 00:00 ‚Üí 2021.05.19 00:00)

                document.getElementById('timeDisplay').textContent = 
                    `ÏãúÎÆ¨Î†àÏù¥ÏÖò ÏãúÍ∞Ñ : ${kstString}`;
            }
        }

        resetSimulation() {
            this.pauseSimulation();

            // üîπ Ï¥àÍ∏∞ Ìïú Îã¨(3/25~4/25) Îç∞Ïù¥ÌÑ∞ÍπåÏßÄ ÎØ∏Î¶¨ ÌëúÏãú
            const preloadEnd = new Date("2021-04-25T23:59:59+09:00").getTime();
            const data = this.historicalData[this.currentMarket];
            let preloadIndex = data.findIndex(d => d.timestamp >= preloadEnd);
            if (preloadIndex === -1) preloadIndex = 0;

            this.currentDataIndex = preloadIndex;  // ‚úÖ Ìïú Îã¨ Íµ¨Í∞Ñ ÎØ∏Î¶¨ Í∑∏Î¶º
            this.startIndex = preloadIndex;        // ‚úÖ ÏãúÎÆ¨Î†àÏù¥ÏÖò ÏãúÏûëÏ†ê Ïû¨ÏÑ§Ï†ï

            this.portfolio = {
                krw: this.initialKrw,
                btc: { amount: 0, totalCost: 0 },
                eth: { amount: 0, totalCost: 0 },
                xrp: { amount: 0, totalCost: 0 }
            };
            this.tradeHistory = [];

            // ‚úÖ Îâ¥Ïä§ ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî (_userAction Ï†úÍ±∞)
            this.newsList.forEach(n => delete n._userAction);

            // ‚úÖ Îâ¥Ïä§ ÌÉÄÏûÑÎùºÏù∏ Ï¥àÍ∏∞Ìôî
            document.getElementById("news-timeline").innerHTML = "";

            this.updateMarketPrices();
            this.updateChart(); // ‚úÖ Ï¥àÍ∏∞ Ìïú Îã¨ Îç∞Ïù¥ÌÑ∞ Î∞òÏòÅ
            document.getElementById('statusText').textContent = 'ÏãúÎÆ¨Î†àÏù¥ÏÖò Î¶¨ÏÖã ÏôÑÎ£å';
        }

        switchTradingMode(isBuy) {
            this.isBuyMode = isBuy;
            
            document.querySelectorAll('.trading-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(isBuy ? 'buyTab' : 'sellTab').classList.add('active');
            
            const orderBtn = document.getElementById('orderBtn');
            orderBtn.textContent = isBuy ? 'Îß§Ïàò' : 'Îß§ÎèÑ';
            orderBtn.className = `order-btn ${isBuy ? 'buy-btn' : 'sell-btn'}`;
            
            this.clearOrderForm();
        }

        setOrderAmount(percent) {
            if (document.activeElement.id !== 'percentageInput') {
                document.getElementById('percentageInput').value = percent;
            }
            const currentPrice = this.currentPrices[this.currentMarket];
            if (!currentPrice || currentPrice === 0) return;

            if (this.isBuyMode) {
                const availableKrw = this.portfolio.krw;
                const orderTotal = (availableKrw * percent / 100);
                const orderAmount = orderTotal / currentPrice;
                
                document.getElementById('orderAmount').value = orderAmount.toFixed(8);
            } else {
                const availableCoin = this.portfolio[this.currentMarket].amount;
                const orderAmount = (availableCoin * percent / 100);
                
                document.getElementById('orderAmount').value = orderAmount.toFixed(8);
            }
            
            this.calculateOrderTotal();
        }

        calculateOrderTotal() {
            const amount = parseFloat(document.getElementById('orderAmount').value) || 0;
            const price = parseFloat(document.getElementById('orderPrice').value) || this.currentPrices[this.currentMarket];
            const total = amount * price;
            
            document.getElementById('orderTotal').value = Math.floor(total);
        }

        showOrderModal() {
            const amount = parseFloat(document.getElementById('orderAmount').value);
            const price = parseFloat(document.getElementById('orderPrice').value) || this.currentPrices[this.currentMarket];
            const total = amount * price;

            if (!this.validateOrder(amount, price, total)) {
                return;
            }

            const summary = `
                <div class="summary-row">
                    <span>ÎßàÏºì:</span>
                    <span>${this.currentMarket.toUpperCase()}/KRW</span>
                </div>
                <div class="summary-row">
                    <span>Ï£ºÎ¨∏Íµ¨Î∂Ñ:</span>
                    <span>${this.isBuyMode ? 'Îß§Ïàò' : 'Îß§ÎèÑ'}</span>
                </div>
                <div class="summary-row">
                    <span>Ï£ºÎ¨∏ÏàòÎüâ:</span>
                    <span>${amount.toFixed(8)} ${this.currentMarket.toUpperCase()}</span>
                </div>
                <div class="summary-row">
                    <span>Ï£ºÎ¨∏Îã®Í∞Ä:</span>
                    <span>${price.toLocaleString()} KRW</span>
                </div>
                <div class="summary-row">
                    <span>Ï£ºÎ¨∏Ï¥ùÏï°:</span>
                    <span>${Math.floor(total).toLocaleString()} KRW</span>
                </div>
            `;

            document.getElementById('orderSummary').innerHTML = summary;
            document.getElementById('orderModal').style.display = 'block';
        }

        hideOrderModal() {
            document.getElementById('orderModal').style.display = 'none';
        }

        validateOrder(amount, price, total) {
            this.hideError();

            if (!amount || amount <= 0) {
                this.showError('Ï£ºÎ¨∏ ÏàòÎüâÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return false;
            }

            if (!price || price <= 0) {
                this.showError('Ïò¨Î∞îÎ•∏ Í∞ÄÍ≤©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return false;
            }

            if (this.isBuyMode) {
                if (total > this.portfolio.krw) {
                    this.showError('Î≥¥Ïú† KRWÍ∞Ä Î∂ÄÏ°±Ìï©ÎãàÎã§.');
                    return false;
                }
            } else {
                if (amount > this.portfolio[this.currentMarket].amount) {
                    this.showError(`Î≥¥Ïú† ${this.currentMarket.toUpperCase()}Í∞Ä Î∂ÄÏ°±Ìï©ÎãàÎã§.`);
                    return false;
                }
            }

            return true;
        }

        executeOrder() {
            const amount = parseFloat(document.getElementById('orderAmount').value);
            const price = parseFloat(document.getElementById('orderPrice').value) || this.currentPrices[this.currentMarket];
            const total = amount * price;

            if (!this.validateOrder(amount, price, total)) {
                this.hideOrderModal();
                return;
            }

            const asset = this.portfolio[this.currentMarket];

            if (this.isBuyMode) {
                this.portfolio.krw -= total;
                asset.amount += amount;
                asset.totalCost += total;
            } else {
                this.portfolio.krw += total;
                if (asset.amount > 0) {
                    const costPerCoin = asset.totalCost / asset.amount;
                    asset.totalCost -= costPerCoin * amount;
                }
                asset.amount -= amount;
                if (asset.amount < 1e-8) {
                    asset.amount = 0;
                    asset.totalCost = 0;
                }
            }

            this.tradeHistory.push({
                timestamp: this.historicalData[this.currentMarket][this.currentDataIndex].timestamp,
                market: this.currentMarket,
                type: this.isBuyMode ? 'buy' : 'sell',
                amount,
                price,
                total
            });

            this.updatePortfolioDisplay();
            this.clearOrderForm();
            this.hideOrderModal();
            
            const message = `${this.isBuyMode ? 'Îß§Ïàò' : 'Îß§ÎèÑ'} Ï£ºÎ¨∏Ïù¥ Ï≤¥Í≤∞ÎêòÏóàÏäµÎãàÎã§.`;
            document.getElementById('statusText').textContent = message;
            setTimeout(() => {
                document.getElementById('statusText').textContent = 
                    this.isSimulationRunning ? 'ÏãúÎÆ¨Î†àÏù¥ÏÖò Ïã§Ìñâ Ï§ë' : 'ÏãúÎÆ¨Î†àÏù¥ÏÖò ÎåÄÍ∏∞ Ï§ë';
            }, 3000);
        }

        updatePortfolioDisplay() {
            document.getElementById('krwBalance').textContent = Math.floor(this.portfolio.krw).toLocaleString();
            
            let totalAssets = this.portfolio.krw;
            Object.keys(this.portfolio).forEach(market => {
                if (market !== 'krw') {
                    const asset = this.portfolio[market];
                    const currentPrice = this.currentPrices[market] || 0;
                    totalAssets += asset.amount * currentPrice;
                }
            });
            
            document.getElementById('totalAssets').textContent = Math.floor(totalAssets).toLocaleString();
            
            const profitRate = ((totalAssets - this.initialKrw) / this.initialKrw * 100).toFixed(2);
            const profitElement = document.getElementById('profitRate');
            profitElement.textContent = `${profitRate}%`;
            profitElement.className = `balance-value ${profitRate >= 0 ? 'positive' : 'negative'}`;

            this.updateHoldingsList();
        }

        updateHoldingsList() {
            const holdingsList = document.getElementById('holdingsList');
            holdingsList.innerHTML = ''; 

            const krwItem = document.createElement('div');
            krwItem.className = 'holding-item';
            krwItem.innerHTML = `
                <div>
                    <div class="holding-symbol">KRW</div>
                    <div>ÌòÑÍ∏à</div>
                </div>
                <div class="holding-details">
                    <div class="detail-label">Î≥¥Ïú†Í∏àÏï°</div>
                    <div class="detail-value">${Math.floor(this.portfolio.krw).toLocaleString()} Ïõê</div>
                </div>
            `;
            holdingsList.appendChild(krwItem);

            Object.keys(this.portfolio).forEach(market => {
                if (market !== 'krw' && this.portfolio[market].amount > 1e-8) { 
                    const asset = this.portfolio[market];
                    const currentPrice = this.currentPrices[market] || 0;
                    
                    const amount = asset.amount;
                    const avgPrice = (amount > 0) ? asset.totalCost / amount : 0;
                    const currentValue = amount * currentPrice;
                    const pnl = currentValue - asset.totalCost;
                    const pnlRate = (asset.totalCost > 0) ? (pnl / asset.totalCost * 100).toFixed(2) : 0;
                    const pnlClass = pnl >= 0 ? 'positive' : 'negative';

                    const coinItem = document.createElement('div');
                    coinItem.className = 'holding-item';
                    coinItem.innerHTML = `
                        <div>
                            <div class="holding-symbol">${market.toUpperCase()}</div>
                            <div class="holding-pnl ${pnlClass}">
                                ${pnl >= 0 ? '+' : ''}${Math.floor(pnl).toLocaleString()} Ïõê (${pnlRate}%)
                            </div>
                        </div>
                        <div class="holding-details">
                            <div class="detail-label">Î≥¥Ïú†ÏàòÎüâ</div>
                            <div class="detail-value">${amount.toFixed(8)}</div>
                            <div class="detail-label">Îß§ÏàòÌèâÍ∑†Í∞Ä</div>
                            <div class="detail-value">${Math.floor(avgPrice).toLocaleString()}</div>
                            <div class="detail-label">ÌèâÍ∞ÄÍ∏àÏï°</div>
                            <div class="detail-value">${Math.floor(currentValue).toLocaleString()}</div>
                        </div>
                    `;
                    holdingsList.appendChild(coinItem);
                }
            });
        }

        startSimulation() {
            if (this.isSimulationRunning) return;
            
            this.isSimulationRunning = true;
            document.getElementById('statusText').textContent = 'ÏãúÎÆ¨Î†àÏù¥ÏÖò Ïã§Ìñâ Ï§ë';
            document.getElementById('playBtn').classList.add('active');
            document.getElementById('pauseBtn').classList.remove('active');

            // üîπ ÏãúÎÆ¨Î†àÏù¥ÏÖò ÏãúÏûëÏùÄ startIndexÎ∂ÄÌÑ∞
            if (this.currentDataIndex < this.startIndex) {
                this.currentDataIndex = this.startIndex;
            }

            this.simulationInterval = setInterval(() => {
                this.nextDataPoint();
            }, 1000 / this.simulationSpeed);
        }

        pauseSimulation() {
            this.isSimulationRunning = false;
            document.getElementById('statusText').textContent = 'ÏãúÎÆ¨Î†àÏù¥ÏÖò ÏùºÏãúÏ†ïÏßÄ';
            document.getElementById('playBtn').classList.remove('active');
            document.getElementById('pauseBtn').classList.add('active');
            
            if (this.simulationInterval) {
                clearInterval(this.simulationInterval);
            }
        }

        nextDataPoint() {
            const maxDataLength = this.historicalData[this.currentMarket].length;

            if (this.currentDataIndex >= maxDataLength - 1) {
                this.pauseSimulation();
                document.getElementById('statusText').textContent = 'ÏãúÎÆ¨Î†àÏù¥ÏÖò ÏôÑÎ£å';

                const totalAssets = this.portfolio.krw + Object.keys(this.portfolio)
                    .filter(m => m !== 'krw')
                    .reduce((sum, market) => sum + this.portfolio[market].amount * this.currentPrices[market], 0);

                const profitAmount = totalAssets - this.initialKrw;
                const profitRate = (profitAmount / this.initialKrw * 100).toFixed(2);
                const pnlClass = profitAmount >= 0 ? 'positive' : 'negative';

                document.getElementById('finalAssets').textContent = `${Math.floor(totalAssets).toLocaleString()} KRW`;

                const finalPnlEl = document.getElementById('finalPnl');
                finalPnlEl.textContent = `${profitAmount >= 0 ? '+' : ''}${Math.floor(profitAmount).toLocaleString()} KRW`;
                finalPnlEl.className = pnlClass;

                const finalPnlRateEl = document.getElementById('finalPnlRate');
                finalPnlRateEl.textContent = `${profitRate}%`;
                finalPnlRateEl.className = pnlClass;

                document.getElementById('resultsModal').style.display = 'block';
                return;
            }

            // üîπ ÏùºÎ¥â Îç∞Ïù¥ÌÑ∞ Í∏∞Ï§ÄÏúºÎ°ú ÏßÑÌñâ (Í∏∞Ï°¥ Î°úÏßÅ Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö© Í∞ÄÎä•)
            const prevTime = this.historicalData[this.currentMarket][this.currentDataIndex]?.timestamp || 0;
            this.currentDataIndex++;
            const currentTime = this.historicalData[this.currentMarket][this.currentDataIndex]?.timestamp || prevTime;

            this.updateMarketPrices();
            this.updateChart();   // ‚úÖ ÏùºÎ¥â Îç∞Ïù¥ÌÑ∞Ïùº ÎïåÎèÑ Ï∞®Ìä∏ Ï¶âÏãú Í∞±Ïã†

            // üîπ Îâ¥Ïä§ Î∞úÏÉù Ï≤¥ÌÅ¨ (ÏùºÎ¥âÏóêÏÑúÎèÑ ÎèôÏùºÌïòÍ≤å Ï†ÅÏö©)
            const matched = this.newsList.find(n => {
                const newsTime = new Date(n.time.replace(" ", "T") + "+09:00").getTime();
                return newsTime > prevTime && newsTime <= currentTime;
            });
            if (matched) {
                this.showNewsPopup(matched);
                this.addNewsToTimeline(matched);
            }
        }
        
        addNewsToTimeline(news) {
            const box = document.getElementById("news-timeline");
            let div = [...box.children].find(d => d.dataset.time === news.time);

            let actionTag = "";
            if (news._userAction === "buy") {
                actionTag = ` <span style="color:#d73527;">(Îß§Ïàò)</span>`;
            } else if (news._userAction === "sell") {
                actionTag = ` <span style="color:#1261c4;">(Îß§ÎèÑ)</span>`;
            } else if (news._userAction === "hold") {
                actionTag = ` <span style="color:#aaa;">(Ïú†ÏßÄ)</span>`;
            }

            if (!div) {
                div = document.createElement("div");
                div.classList.add("news-item");
                div.dataset.time = news.time;
                box.appendChild(div);
            }

            div.innerHTML = `<strong>${news.time}</strong><br>${news.title}${actionTag}`;
            div.onclick = () => this.showNewsPopup(news);
        }

        showNewsPopup(news) {
            this.pauseSimulation();
            this.currentNews = news;

            // ÎÇ†Ïßú Ï∂îÍ∞Ä
            const date = new Date(news.time.replace(" ", "T") + "+09:00");
            const dateStr = date.toLocaleString("ko-KR", {
                year: "numeric", month: "2-digit", day: "2-digit",
                hour: "2-digit", minute: "2-digit", timeZone: "Asia/Seoul"
            });

            document.getElementById("news-popup-title").innerText = `üì∞${news.title}`;
            document.getElementById("news-popup-date").innerText = `${dateStr}`;
            document.getElementById("news-popup-desc").innerText = news.description || "";
            document.getElementById("overlay").style.display = "block";
            document.getElementById("news-popup").style.display = "block";

            // Ï¥àÍ∏∞ ÏÉÅÌÉú
            document.getElementById("news-popup-choice").style.display = "flex";
            document.getElementById("news-trade-form").style.display = "none";

            // Îß§Ïàò Î≤ÑÌäº
            document.getElementById("news-popup-buy").onclick = () => {
                this.isBuyMode = true;
                document.getElementById("news-trade-form").style.display = "block";
                const confirmBtn = document.getElementById("news-orderConfirm");
                confirmBtn.textContent = "Îß§Ïàò";
                confirmBtn.className = "order-btn buy-btn";
            };

            // Îß§ÎèÑ Î≤ÑÌäº
            document.getElementById("news-popup-sell").onclick = () => {
                this.isBuyMode = false;
                document.getElementById("news-trade-form").style.display = "block";
                const confirmBtn = document.getElementById("news-orderConfirm");
                confirmBtn.textContent = "Îß§ÎèÑ";
                confirmBtn.className = "order-btn sell-btn";
            };

            // Ïú†ÏßÄ Î≤ÑÌäº
            document.getElementById("news-popup-hold").onclick = () => {
                this.currentNews._userAction = "hold";
                this.addNewsToTimeline(this.currentNews);

                document.getElementById("news-popup").style.display = "none";
                document.getElementById("overlay").style.display = "none";
                this.startSimulation();
            };

            // ÏûÖÎ†• Ïù¥Î≤§Ìä∏ ‚Üí Ï¥ùÏï° ÏûêÎèô Í≥ÑÏÇ∞
            document.getElementById("news-orderAmount").oninput = () => this.calculateNewsOrderTotal();
            document.getElementById("news-orderPrice").oninput = () => this.calculateNewsOrderTotal();

            // ÌçºÏÑºÌä∏ Î≤ÑÌäº
            document.querySelectorAll('#news-trade-form .percentage-btn').forEach(btn => {
                btn.onclick = () => {
                    const percent = parseInt(btn.dataset.percent);
                    this.setNewsOrderAmount(percent);
                };
            });

            // ÏßÅÏ†ëÏûÖÎ†• %
            document.getElementById("news-percentageInput").oninput = (e) => {
                let val = parseFloat(e.target.value);
                if (isNaN(val) || val < 0) val = 0;
                if (val > 100) val = 100;
                this.setNewsOrderAmount(val);
            };

            // ÌôïÏù∏ Î≤ÑÌäº
            document.getElementById("news-orderConfirm").onclick = () => {
                const amount = parseFloat(document.getElementById("news-orderAmount").value);
                const price = parseFloat(document.getElementById("news-orderPrice").value) || this.currentPrices[this.currentMarket];
                const total = amount * price;

                // ÌåùÏóÖ Ï†ÑÏö© Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
                if (!amount || amount <= 0) {
                    alert("Ï£ºÎ¨∏ ÏàòÎüâÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
                    return;
                }
                if (!price || price <= 0) {
                    alert("Ïò¨Î∞îÎ•∏ Í∞ÄÍ≤©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
                    return;
                }
                
                this.currentNews._userAction = this.isBuyMode ? "buy" : "sell";
                this.addNewsToTimeline(this.currentNews);

                const summary = `
                    <div class="summary-row">
                        <span>ÎßàÏºì:</span>
                        <span>${this.currentMarket.toUpperCase()}/KRW</span>
                    </div>
                    <div class="summary-row">
                        <span>Ï£ºÎ¨∏Íµ¨Î∂Ñ:</span>
                        <span>${this.isBuyMode ? 'Îß§Ïàò' : 'Îß§ÎèÑ'}</span>
                    </div>
                    <div class="summary-row">
                        <span>Ï£ºÎ¨∏ÏàòÎüâ:</span>
                        <span>${amount.toFixed(8)} ${this.currentMarket.toUpperCase()}</span>
                    </div>
                    <div class="summary-row">
                        <span>Ï£ºÎ¨∏Îã®Í∞Ä:</span>
                        <span>${price.toLocaleString()} KRW</span>
                    </div>
                    <div class="summary-row">
                        <span>Ï£ºÎ¨∏Ï¥ùÏï°:</span>
                        <span>${Math.floor(total).toLocaleString()} KRW</span>
                    </div>
                `;

                document.getElementById("orderSummary").innerHTML = summary;
                document.getElementById("orderModal").style.display = "block";

                document.getElementById("news-popup").style.display = "none";
                document.getElementById("overlay").style.display = "none";
            };
            // ÏàòÎüâ/Í∞ÄÍ≤© ÏûÖÎ†• Ïãú ‚Üí ÌåùÏóÖ Ï¥ùÏï° ÏûêÎèô Í≥ÑÏÇ∞
            document.getElementById("news-orderAmount").oninput = () => this.calculateNewsOrderTotal();
            document.getElementById("news-orderPrice").oninput = () => this.calculateNewsOrderTotal();

            // ÌçºÏÑºÌä∏ Î≤ÑÌäº
            document.querySelectorAll('#news-trade-form .percentage-btn').forEach(btn => {
                btn.onclick = () => {
                    const percent = parseInt(btn.dataset.percent);
                    this.setNewsOrderAmount(percent);
                };
            });

            // ÏßÅÏ†ëÏûÖÎ†• %
            document.getElementById("news-percentageInput").oninput = (e) => {
                let val = parseFloat(e.target.value);
                if (isNaN(val) || val < 0) val = 0;
                if (val > 100) val = 100;
                this.setNewsOrderAmount(val);
            };
        }
        
        setNewsOrderAmount(percent) {
            const currentPrice = this.currentPrices[this.currentMarket];
            if (!currentPrice || currentPrice === 0) return;

            let orderAmount;
            if (this.isBuyMode) {
                const availableKrw = this.portfolio.krw;
                const orderTotal = (availableKrw * percent / 100);
                // üîπ Ïö∞Ï∏° Í±∞ÎûòÏ∞Ω Î∞©Ïãù Í∑∏ÎåÄÎ°ú Ï†ÅÏö©
                orderAmount = (orderTotal / currentPrice) - 1e-8;
            } else {
                const availableCoin = this.portfolio[this.currentMarket].amount;
                orderAmount = (availableCoin * percent / 100);
            }

            // ÌåùÏóÖÏ∞Ω Í∞í Í∞±Ïã†
            document.getElementById("news-orderAmount").value = orderAmount.toFixed(8);
            this.calculateNewsOrderTotal();

            // üîπ Ïö∞Ï∏° Í±∞ÎûòÏ∞Ω Í∞íÎèÑ ÎèôÏùºÌïòÍ≤å Í∞±Ïã†
            document.getElementById("orderAmount").value = orderAmount.toFixed(8);
            this.calculateOrderTotal();
        }

        calculateNewsOrderTotal() {
            const amount = parseFloat(document.getElementById("news-orderAmount").value) || 0;
            const price = parseFloat(document.getElementById("news-orderPrice").value) || this.currentPrices[this.currentMarket];
            const total = amount * price;
            document.getElementById("news-orderTotal").value = Math.floor(total);
        }

        clearOrderForm() {
            document.getElementById('orderAmount').value = '';
            document.getElementById('orderPrice').value = '';
            document.getElementById('orderTotal').value = '';
            document.getElementById('percentageInput').value = '';
        }

        showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }

        hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        updateDisplay() {
            this.updateCurrentMarketDisplay();
            this.updatePortfolioDisplay();
            this.updateChart();
        }
        
        addUserActionToTimeline(news, type, amountKRW) {
            const box = document.getElementById("news-timeline");
            const div = document.createElement("div");
            div.classList.add("user-action");

            let text = "";
            if (type === "buy") {
                text = `üëâ [ÏÇ¨Ïö©Ïûê] ${Math.floor(amountKRW).toLocaleString()} KRW Îß§Ïàò Ïã§Ìñâ`;
                div.style.color = "#d73527";
            } else if (type === "sell") {
                text = `üëâ [ÏÇ¨Ïö©Ïûê] ${Math.floor(amountKRW).toLocaleString()} KRW Îß§ÎèÑ Ïã§Ìñâ`;
                div.style.color = "#1261c4";
            } else {
                text = `üëâ [ÏÇ¨Ïö©Ïûê] Ïú†ÏßÄ ÏÑ†ÌÉù`;
                div.style.color = "#aaa";
            }

            div.innerText = `${news.time} - ${text}`;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        window.tradingSystem = new HistoricalTradingSystem();
    });
</script>
</body>
</html>