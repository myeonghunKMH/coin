<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ÏãúÎÇòÎ¶¨Ïò§3 | Ïú†ÏßÄÏû•</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.1.0/dist/chartjs-chart-financial.min.js"></script>

  <style>
    :root{
      --bg:#212121; --panel:#1f1f1f; --panel-2:#1f1f1f;
      --line:#424242; --hairline:#5e5e5e; --text:#E8ECF3; --muted:#bfc6d6;
      --active:#ffffff; --active-600:#a3a3a3;
      --headline:#ffd166;
      --candle-up:  rgb(255, 103, 103);
      --candle-down:rgb(74, 196, 175);
      --vol-up:     rgba(255, 103, 103,.34);
      --vol-down:   rgba(74, 196, 175,.30);
      --font-sm:12.5px; --font-md:14.5px; --font-lg:18px;
      --price-h:62vh; --vol-h:16vh;
    }
    *{box-sizing:border-box}
    body{margin:0;background:#1f1f1f;color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif}

    .header{display:flex;align-items:center;justify-content:center;padding:16px;border-bottom:1px solid var(--line);position:relative;background:var(--panel)}
    .header .left-tools{position:absolute;left:12px;top:50%;transform:translateY(-50%);display:flex;gap:10px;align-items:center}
    .back-btn{padding:9px 12px;border-radius:12px;background:rgba(63, 63, 63, 0.705);border:1px solid var(--hairline);color:#dfe5f1;text-decoration:none;font-weight:700;height: 35px;display:flex;align-items: center;}
    .header-date{font-family:ui-monospace,Menlo,Consolas,monospace;color:#ffffff;font-size:15px;opacity:.95}

    .scenario-wrap{display:flex;flex-direction:column;align-items:center;gap:6px}
    .scenario-badge{padding:5px 12px;border-radius:14px;background:rgba(49, 49, 49, 0.705);border:1px solid #bbbbbb;color:#bbbbbb;font-size:13px;font-weight:700}
    .scenario-title{font-weight:800;color:#bbbbbb}
    .balances{position:absolute;right:12px;top:50%;transform:translateY(-50%);display:flex;gap:10px}
    .b-item{padding:10px 12px;border:1px solid var(--line);border-radius:14px;background:linear-gradient(180deg,rgba(63, 63, 63, 0), rgb(63, 63, 63))}
    .b-label{font-size:var(--font-sm);color:#bac0cc}
    .b-value{font-size:var(--font-lg);font-weight:800;color:#eef3ff}
    .positive{color:#9CD67A}.negative{color:#FF7A7A}

    .grid{display:grid; gap:1px;
      grid-template-columns:1.05fr 1.05fr 0.95fr; grid-auto-rows:min-content;
      min-height:calc(92vh - 64px); border-top:1px solid var(--line); position:relative;}
    .grid-bottom{position:absolute;left:0;right:0;bottom:0;height:1px;background:var(--line);}
    .col{background:var(--panel-2);display:flex;flex-direction:column;min-width:0}
    #leftCol{border-right:1px solid var(--line)}
    #rightCol { border-right:1px solid var(--line); }

    .pane-header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--line);background:linear-gradient(180deg,#212121,#212121)}
    .pane-title{display:flex;align-items:center;gap:10px;color:#ffd166;}
    .badge{font-size:var(--font-sm);padding:4px 10px;border-radius:999px;border:1px solid var(--hairline);color:#bebebe;background:rgba(255,255,255,.02)}
    .badge.active{border-color:#ffd166;color:#ffd166}
    .price-block{text-align:right}.big{font-size:var(--font-lg);font-weight:800}.sub{font-size:var(--font-sm);color:#9aa0a6}

    .chart-wrap{flex:1;padding:12px;display:flex;flex-direction:column;gap:10px}
    .chart-box{position:relative;border:1px solid rgba(255,255,255,.08);border-radius:14px;overflow:hidden;background:#1b1b1b}
    .price-box{height:var(--price-h)}
    .vol-box{height:var(--vol-h)}
    .chart{width:100%;height:100%;display:block}

    .trade-panel{padding:12px;display:flex;flex-direction:column;gap:12px}
    .seg{display:grid;gap:10px;background:rgba(43, 43, 43, 0.555);border:1px solid var(--line);border-radius:14px;padding:15px}
    .seg-title{font-weight:900;border-bottom:1px dashed var(--hairline);padding-bottom:8px}

    .toolbar{display:flex;align-items:center;gap:8px}
    .controls-left{display:flex;gap:8px;align-items:center}
    .btn{padding:10px 14px;border-radius:12px;font-weight:800;border:1px solid #414141;background:#202020;color:#b1b1b1;cursor:pointer}
    .btn.is-active{border-color:var(--active);color:var(--active)}
    .speed-wrap{margin-left:auto;display:flex;align-items:center;gap:6px}
    #speedSlider{width:220px; accent-color: #cacaca;}

    .tabs{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .tab{padding:10px 12px;border:1px solid var(--line);background:#202020;color:#cacaca;text-align:center;border-radius:12px;font-weight:800;cursor:pointer}
    .tab.active{background:#d6d6d6;border-color:#d6d6d6;color:#0b0c0f}

    .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .label{font-size:var(--font-sm);color:#ffffff; margin-bottom: 6px;}
    .input{width:100%;padding:12px;border:1px solid var(--line);background:#202020;color:#e9eef8;border-radius:12px}

    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button{background:transparent}
    input[type="number"]{background:#202020}

    .pct-row{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;margin-bottom:-13px}
    .pct{padding:10px;border:1px solid var(--line);background:#202020;color:#cfd5e2;border-radius:12px;cursor:pointer;font-size:12px;font-weight:800}
    .warn{min-height:18px;display:flex;align-items:center;font-size:12px;color:#f08585;background:rgba(229,62,62,.08);padding:6px;border-radius:12px;border:1px dashed rgba(229,62,62,.15);visibility:hidden;margin:10px 0 4px}
    .warn.show{visibility:visible}
    .order-row{grid-template-columns:1fr;margin-top:-4px;}
    .order-btn{width:100%;padding:12px;border-radius:12px;font-weight:900;border:0;cursor:pointer;background:linear-gradient(180deg,var(--active),var(--active-600));color:#0b0c0f}

    .holdings-2col{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .card{border:1px solid var(--line);border-radius:12px;padding:10px;background:#202020}
    .kv{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dashed rgba(255,255,255,.08)}
    .kv:last-child{border-bottom:0}

    /* === Îâ¥Ïä§ Î™®Îã¨ === */
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,4,8,.60);display:none;align-items:center;justify-content:center;z-index:9999}
    .modal{width:min(920px,96vw);background:#1a1a1a;border:1px solid var(--line);border-radius:16px;box-shadow:0 32px 90px rgba(0,0,0,.6);overflow:hidden}
    .modal-header{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:1px solid var(--line);font-weight:900}
    .modal-body{padding:16px;display:grid;gap:14px}
    .hr{height:1px;background:var(--line);margin:6px 0}
    .modal-actions{display:flex;justify-content:flex-end;gap:8px;padding:12px 16px;border-top:1px solid var(--line)}
    .mbtn{padding:10px 12px;border-radius:12px;border:1px solid #2a2f38;background:linear-gradient(180deg,var(--active),var(--active-600));color:#0b0c0f;font-weight:900;cursor:pointer}

    .news-list{display:grid;gap:8px}
    .news-item{border:1px solid var(--line);border-radius:10px;padding:10px;background:#151515}
    .news-time{font-size:12px;color:#9aa2b4}
    .news-title{font-weight:800;font-size:13px;color:#e7edf8}

    #newsHeadline{font-weight:900;font-size:18px;color:var(--headline);letter-spacing:.2px}
    .news-form{display:grid;grid-template-columns:1fr;gap:12px}
    .news-form .row{grid-template-columns:1fr 1fr}
    .news-pcts{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}

    /* ÌïòÎã® ÏßÑÌñâ ÏÉÅÌÉú */
    .footer-strip{margin-top:8px;border-top:1px solid var(--line);padding:8px 10px;color:#a7a7a7;font-size:15px;display:flex;justify-content:space-between}
    #simStatus{white-space:nowrap}
    #simCounter{white-space:nowrap}

    /* === dd.htmlÏùò ÌäúÌÜ†Î¶¨Ïñº(ÏïàÎÇ¥) Ï†ÑÏö© Î™®Îã¨ === */
    .notice-backdrop{position:fixed;inset:0;background:rgba(0, 0, 0, 0.705);display:none;align-items:center;justify-content:center;z-index:10000}
    .notice{width:min(680px,94vw);background:#1a1a1a;border:1px solid #464646;border-radius:14px;box-shadow:0 24px 64px rgba(0,0,0,.65);overflow:hidden}
    .notice-header{padding:16px 18px;border-bottom:1px solid var(--line);font-size:20px;font-weight:800}
    .notice-body{padding:16px 18px;color:#e8e8e8;line-height:1.6}
    .notice-body p{margin:0 0 8px 0;color:#cfcfcf}
    .notice-body ol{margin:8px 0 12px 20px}
    .notice-body li{margin:6px 0}
    .notice-actions{display:flex;justify-content:flex-end;gap:8px;padding:12px 16px;border-top:1px solid var(--line)}

    @media (max-width:1200px){
      .grid{grid-template-columns:1fr;min-height:auto}
      .news-form .row{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="left-tools">
      <a href="/historical.html" class="back-btn">‚Üê ÌäúÌÜ†Î¶¨ÏñºÎ°ú</a>
      <button id="newsToggle" class="back-btn" title="Îâ¥Ïä§ ÌÉÄÏûÑÎùºÏù∏">üì∞</button>
      <button id="helpBtn" class="back-btn" title="ÌäúÌÜ†Î¶¨Ïñº ÏïàÎÇ¥ Î≥¥Í∏∞" aria-label="ÌäúÌÜ†Î¶¨Ïñº ÏïàÎÇ¥ Î≥¥Í∏∞">üìñ</button>
      <div class="header-date" id="timebox">ÎåÄÍ∏∞Ï§ë‚Ä¶</div>
    </div>
    <div class="scenario-wrap">
      <span class="scenario-badge">SCENARIO 03</span>
      <span class="scenario-title">Ïú†ÏßÄÏû•: Ìö°Î≥¥ & Í±∞ÎûòÎüâ Í∞êÏÜå</span>
    </div>
    <div class="balances">
      <div class="b-item"><div class="b-label">Î≥¥Ïú† KRW</div><div class="b-value" id="krwBalance">100,000,000</div></div>
      <div class="b-item"><div class="b-label">Ï¥ù ÏûêÏÇ∞</div><div class="b-value" id="totalAssets">100,000,000</div></div>
      <div class="b-item"><div class="b-label">ÏàòÏùµÎ•†</div><div class="b-value" id="profitRate">0.00%</div></div>
    </div>
  </div>

  <div class="grid" id="gridRoot">
    <!-- BTC -->
    <section class="col" id="leftCol">
      <div class="pane-header">
        <div class="pane-title">
          <span class="badge active" id="badgeBTC">ACTIVE</span>
          <div><div style="font-weight:800;">BTC / KRW</div><div class="sub" id="btcRange">ÏùºÎ¥â</div></div>
        </div>
        <div class="price-block"><div class="big" id="btcPrice">-</div><div class="sub" id="btcChange">-</div></div>
      </div>
      <div class="chart-wrap">
        <div class="chart-box price-box"><canvas id="btcPriceChart" class="chart"></canvas></div>
        <div class="chart-box vol-box"><canvas id="btcVolChart" class="chart"></canvas></div>
      </div>
    </section>

    <!-- XRP -->
    <section class="col" id="rightCol">
      <div class="pane-header">
        <div class="pane-title">
          <span class="badge" id="badgeXRP">ACTIVE</span>
          <div><div style="font-weight:800;">XRP / KRW</div><div class="sub" id="xrpRange">ÏùºÎ¥â</div></div>
        </div>
        <div class="price-block"><div class="big" id="xrpPrice">-</div><div class="sub" id="xrpChange">-</div></div>
      </div>
      <div class="chart-wrap">
        <div class="chart-box price-box"><canvas id="xrpPriceChart" class="chart"></canvas></div>
        <div class="chart-box vol-box"><canvas id="xrpVolChart" class="chart"></canvas></div>
      </div>
    </section>

    <!-- Ïö∞Ï∏° Ìå®ÎÑê -->
    <aside class="col">
      <div class="trade-panel">
        <div class="seg">
          <div class="toolbar">
            <div class="controls-left" id="controlsLeft">
              <button class="btn" id="playBtn">‚ñ∂ ÏãúÏûë</button>
              <button class="btn" id="pauseBtn">‚è∏ ÏùºÏãúÏ†ïÏßÄ</button>
              <button class="btn" id="resetBtn">üîÑ Î¶¨ÏÖã</button>
            </div>
            <div class="speed-wrap">
              <label class="label" for="speedSlider">ÏÜçÎèÑ</label>
              <input id="speedSlider" type="range" min="1" max="10" step="1" value="1" />
              <span id="speedVal" class="label">1x</span>
            </div>
          </div>
        </div>

        <div class="seg">
          <div class="seg-title">Ï£ºÎ¨∏ ÏûêÏÇ∞ ÏÑ†ÌÉù</div>
          <div class="tabs">
            <div class="tab active" id="tabBTC">BTC</div>
            <div class="tab" id="tabXRP">XRP</div>
          </div>
        </div>

        <div class="seg">
          <div class="seg-title">Ï£ºÎ¨∏</div>
          <div class="row">
            <div>
              <div class="label">Ï£ºÎ¨∏ Íµ¨Î∂Ñ</div>
              <select class="input" id="side">
                <option value="buy">Îß§Ïàò</option>
                <option value="sell">Îß§ÎèÑ</option>
              </select>
            </div>
            <div>
              <div class="label">Ï≤¥Í≤∞ Îã®Í∞Ä (ÏãúÏû•Í∞Ä)</div>
              <input class="input" id="price" placeholder="ÏãúÏû•Í∞Ä" disabled />
            </div>
          </div>
          <div class="row">
            <div>
              <div class="label">ÏàòÎüâ</div>
              <input class="input" id="amount" type="number" step="0.00000001" placeholder="0" />
            </div>
            <div>
              <div class="label">Ï£ºÎ¨∏ Ï¥ùÏï° (KRW)</div>
              <input class="input" id="total" type="text" placeholder="0" readonly />
            </div>
          </div>
          <div class="pct-row">
            <button class="pct" data-pct="25">25%</button>
            <button class="pct" data-pct="50">50%</button>
            <button class="pct" data-pct="75">75%</button>
            <button class="pct" data-pct="100">MAX</button>
            <input class="input" id="pctInput" type="number" placeholder="ÏßÅÏ†ë%" min="0" max="100" />
          </div>
          <div class="warn" id="warn"></div>
          <div class="row order-row">
            <button class="order-btn" id="orderBtn">Îß§Ïàò</button>
          </div>
        </div>

        <div class="seg">
          <div class="seg-title">Î≥¥Ïú† ÌòÑÌô©</div>
          <div class="holdings-2col">
            <div class="card">
              <div style="font-weight:900;margin-bottom:6px">BTC</div>
              <div class="kv"><span>ÏàòÎüâ</span><span id="holdBTCQty">-</span></div>
              <div class="kv"><span>ÌèâÍ∑†Îã®Í∞Ä</span><span id="holdBTCAvg">-</span></div>
              <div class="kv"><span>ÌèâÍ∞ÄÏÜêÏùµ</span><span id="holdBTCPnL">-</span></div>
            </div>
            <div class="card">
              <div style="font-weight:900;margin-bottom:6px">XRP</div>
              <div class="kv"><span>ÏàòÎüâ</span><span id="holdXRPQty">-</span></div>
              <div class="kv"><span>ÌèâÍ∑†Îã®Í∞Ä</span><span id="holdXRPAvg">-</span></div>
              <div class="kv"><span>ÌèâÍ∞ÄÏÜêÏùµ</span><span id="holdXRPPnL">-</span></div>
            </div>
          </div>
          <div class="kv" style="margin-top:8px;"><span>KRW</span><span id="holdKrw">-</span></div>
        </div>

        <div class="footer-strip">
          <span id="simStatus">ÏãúÎÆ¨Î†àÏù¥ÏÖò ÎåÄÍ∏∞Ï§ë</span>
          <span id="simCounter">- / - Ïùº</span>
        </div>
      </div>
    </aside>

    <div class="grid-bottom"></div>
  </div>

  <!-- Îâ¥Ïä§ ÌÉÄÏûÑÎùºÏù∏ ÌåùÏóÖ -->
  <div id="timelineModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="timelineTitle">
    <div class="modal">
      <div class="modal-header">
        <div id="timelineTitle">Îâ¥Ïä§ ÌÉÄÏûÑÎùºÏù∏</div>
        <button class="mbtn" id="timelineClose" aria-label="Îã´Í∏∞">‚úï</button>
      </div>
      <div class="modal-body">
        <div id="newsTimeline" class="news-list" aria-live="polite"></div>
      </div>
      <div class="modal-actions">
        <button class="mbtn" id="timelineClose2">Îã´Í∏∞</button>
      </div>
    </div>
  </div>

  <!-- Îâ¥Ïä§ ÏÉÅÏÑ∏ ÌåùÏóÖ -->
  <div id="newsModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="newsTitle">
    <div class="modal">
      <div class="modal-header">
        <div id="newsTitle">ÏãúÏû• Îâ¥Ïä§</div>
        <button class="mbtn" id="newsCloseBtn" aria-label="Îã´Í∏∞">‚úï</button>
      </div>
      <div class="modal-body">
        <div id="newsHeadline">-</div>
        <div id="newsBody" style="color:#cfd5e2;line-height:1.6">-</div>
        <div class="hr"></div>

        <div class="news-form">
          <div class="row">
            <div>
              <div class="label">Ï£ºÎ¨∏ Íµ¨Î∂Ñ</div>
              <select class="input" id="newsSide">
                <option value="">--ÏÑ†ÌÉù--</option>
                <option value="buy">Îß§Ïàò</option>
                <option value="sell">Îß§ÎèÑ</option>
                <option value="hold">Ïú†ÏßÄ</option>
              </select>
            </div>
            <div>
              <div class="label">ÏûêÏÇ∞ ÏÑ†ÌÉù</div>
              <div class="tabs" style="margin-bottom:0;">
                <div class="tab active" id="newsTabBTC">BTC</div>
                <div class="tab" id="newsTabXRP">XRP</div>
              </div>
            </div>
          </div>

          <div class="row">
            <div>
              <div class="label">ÏãúÏû•Í∞Ä</div>
              <input class="input" id="newsPrice" placeholder="ÏãúÏû•Í∞Ä" disabled />
            </div>
            <div>
              <div class="label">Ï¥ùÏï° (KRW)</div>
              <input class="input" id="newsTotal" type="text" placeholder="0" readonly />
            </div>
          </div>

          <div class="row">
            <div>
              <div class="label">ÏàòÎüâ</div>
              <input class="input" id="newsAmount" type="number" step="0.00000001" placeholder="0" />
            </div>
            <div>
              <div class="label">ÏßÅÏ†ë %</div>
              <input class="input" id="newsPctInput" type="number" placeholder="ÏßÅÏ†ë%" min="0" max="100" />
            </div>
          </div>

          <div class="news-pcts">
            <button class="pct" data-news-pct="25">25%</button>
            <button class="pct" data-news-pct="50">50%</button>
            <button class="pct" data-news-pct="75">75%</button>
            <button class="pct" data-news-pct="100">MAX</button>
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="mbtn" id="newsConfirmBtn" disabled>ÌôïÏù∏</button>
      </div>
    </div>
  </div>

  <!-- (Ï∂îÍ∞Ä) dd.html: ÌäúÌÜ†Î¶¨Ïñº ÏïàÎÇ¥ Î™®Îã¨ -->
  <div id="noticeModal" class="notice-backdrop" role="dialog" aria-modal="true" aria-labelledby="noticeTitle">
    <div class="notice">
      <div class="notice-header" id="noticeTitle">üìñ ÌäúÌÜ†Î¶¨Ïñº ÏßÑÌñâ Ï†Ñ Ï∞∏Í≥†ÏÇ¨Ìï≠</div>
      <div class="notice-body">
        <p><strong>Îã§ÏùåÏùò ÌùêÎ¶ÑÏùÑ Ïù¥Ìï¥ÌïòÍ≥† ÌäúÌÜ†Î¶¨ÏñºÏùÑ ÏßÑÌñâÌïòÏÑ∏Ïöî.</strong></p>
        <ol>
          <li>2020ÎÖÑÏóê SECÍ∞Ä Î¶¨Ìîå(XRP)ÏùÑ ÏÉÅÎåÄÎ°ú ÏÜåÏÜ°ÏùÑ Ï†úÍ∏∞ÌñàÏäµÎãàÎã§.</li>
          <li>2023ÎÖÑ 6Ïõî Ï§ëÏàúÏóêÎäî ÎπÑÌä∏ÏΩîÏù∏(BTC) ÏãúÏû•Ïù¥ Îã®Í∏∞Í∞Ñ Ï¢ãÏïÑÏ°åÏäµÎãàÎã§.</li>
          <li>2020ÎÖÑÏóê Ï†úÍ∏∞Îêú ÏÜåÏÜ°ÏùÄ 2023ÎÖÑ 7Ïõî 13ÏùºÏóê ÌåêÍ≤∞Ïù¥ ÎÇ¨ÏäµÎãàÎã§.</li>
        </ol>
        <p>Ïù¥Îü¨Ìïú ÏÇ¨Í±¥Îì§ÏùÄ ÏãúÏû•Ïùò ÌùêÎ¶ÑÏùÑ Î∞îÍæ∏Î©∞, ÏÑ†ÌÉùÏóê Îî∞Îùº Í≤∞Í≥ºÍ∞Ä Îã¨ÎùºÏßëÎãàÎã§.<br/>
        Ïù¥Ï†ú Ïù¥Îü¨Ìïú ÌùêÎ¶Ñ ÏÜçÏóêÏÑú Ïñ¥ÎñªÍ≤å ÎåÄÏùëÌï¥Ïïº ÏµúÎåÄÏùò Ïù¥ÏùµÏùÑ ÎÇº Ïàò ÏûàÎäîÏßÄ ÏßÅÏ†ë Í≤ΩÌóòÌï¥Î≥¥ÏÑ∏Ïöî.</p>
      </div>
      <div class="notice-actions">
        <button class="mbtn" id="noticeOkBtn">ÏãúÏûëÌïòÍ∏∞</button>
      </div>
    </div>
  </div>

  <!-- (Ï∂îÍ∞Ä) dd.html: ÏãúÎÆ¨Î†àÏù¥ÏÖò Í≤∞Í≥º ÏöîÏïΩ Î™®Îã¨ -->
  <div id="summaryModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="summaryTitle">
    <div class="modal">
      <div class="modal-header">
        <div id="summaryTitle">ÏãúÎÆ¨Î†àÏù¥ÏÖò Í≤∞Í≥º ÏöîÏïΩ</div>
        <button class="mbtn" id="summaryCloseBtn" aria-label="Îã´Í∏∞">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="kv"><span>Í∏∞Í∞Ñ</span><strong id="sumRange">-</strong></div>
        <div class="kv"><span>ÏµúÏ¢Ö Ï¥ùÏûêÏÇ∞</span><strong id="sumTotal">-</strong></div>
        <div class="kv"><span>Ï¥ù ÏàòÏùµÎ•†</span><strong id="sumPr">-</strong></div>
        <div class="hr"></div>
        <div style="font-weight:700;">Î≥¥Ïú† ÎÇ¥Ïó≠</div>

        <!-- Ï†ÑÌè≠ KRW -->
        <div class="kv"><span>Î≥¥Ïú† KRW</span><strong id="sumKrw">-</strong></div>

        <!-- Ï¢å: BTC / Ïö∞: XRP -->
        <div class="holdings-2col" style="margin-top:8px;">
          <div class="card">
            <div style="font-weight:900;margin-bottom:6px">BTC</div>
            <div class="kv"><span>ÏàòÎüâ</span><strong id="sumBTCQty">-</strong></div>
            <div class="kv"><span>ÌèâÍ∑†Îã®Í∞Ä</span><strong id="sumBTCAvg">-</strong></div>
            <div class="kv"><span>ÌèâÍ∞ÄÏÜêÏùµ</span><strong id="sumBTCPnL">-</strong></div>
          </div>
          <div class="card">
            <div style="font-weight:900;margin-bottom:6px">XRP</div>
            <div class="kv"><span>ÏàòÎüâ</span><strong id="sumXRPQty">-</strong></div>
            <div class="kv"><span>ÌèâÍ∑†Îã®Í∞Ä</span><strong id="sumXRPAvg">-</strong></div>
            <div class="kv"><span>ÌèâÍ∞ÄÏÜêÏùµ</span><strong id="sumXRPPnL">-</strong></div>
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="mbtn" id="summaryOkBtn">Îã´Í∏∞</button>
        <button class="mbtn" id="summaryResetBtn">Î¶¨ÏÖãÌïòÍ≥† Îã§Ïãú ÏãúÏûë</button>
      </div>
    </div>
  </div>

  <script>
    // ===== ÏÉÅÏàò/ÏÉÅÌÉú =====
    const RANGE = { start:"2023-06-01", end:"2023-07-31" };
    const INITIAL_KRW = 100_000_000;
    const WINDOW_DAYS = 15;
    const DECIMALS = { btc:8, xrp:4 };
    const VOL_SCALE = 0.35;
    const EPS = 1e-9;

    const cssVar = n => getComputedStyle(document.documentElement).getPropertyValue(n).trim();
    const CANDLE_UP   = cssVar('--candle-up');
    const CANDLE_DOWN = cssVar('--candle-down');
    const VOL_UP      = cssVar('--vol-up');
    const VOL_DOWN    = cssVar('--vol-down');

    const state = {
      activeAsset:'btc',
      running:false, idx:0, dates:[],
      data:{ btc:[], xrp:[] },
      charts:{ btc:{price:null,vol:null}, xrp:{price:null,vol:null} },
      price:{ btc:0, xrp:0 }, prevPrice:{ btc:0, xrp:0 },
      portfolio:{ krw:INITIAL_KRW, btc:{qty:0,cost:0}, xrp:{qty:0,cost:0} },
      timer:null, speed:1,
      news:[], newsMap:new Map(), newsShown:new Set()
    };

    // ===== Ïú†Ìã∏ =====
    function normDay(t){ return new Date(new Date(t).toDateString()).getTime(); }
    function findByDate(arr, dayTs){ return arr.find(d => normDay(d.ts) === dayTs); }
    function kstDateOnly(ts){
      const d = new Date(ts);
      return d.toLocaleDateString('ko-KR',{ timeZone:'Asia/Seoul', year:'numeric', month:'2-digit', day:'2-digit' });
    }
    function floorToDecimals(value, d){
      const m = 10**d;
      return Math.floor(value * m + EPS)/m;
    }

    // ===== Îç∞Ïù¥ÌÑ∞ =====
    async function fetchDaily(asset){
      const res = await fetch(`/api/daily?asset=${asset}&start=${RANGE.start}&end=${RANGE.end}`);
      if(!res.ok) throw new Error(`${asset} Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ïã§Ìå®`);
      const rows = await res.json();
      return rows.map(r=>({
        ts:new Date(r.candle_date_time_kst).getTime(),
        o:+r.opening_price, h:+r.high_price, l:+r.low_price, c:+r.trade_price,
        v:+(r.candle_acc_trade_volume ?? r.volume ?? 0),
        kst:r.candle_date_time_kst
      }));
    }
    async function fetchNews(){
      const res = await fetch('/api/scenario3/news');
      if(!res.ok) throw new Error('Îâ¥Ïä§ Î°úÎî© Ïã§Ìå®');
      const raw = await res.json();
      const list = raw.map(n => ({
        date: n.time, headline: n.title, body: n.description, asset: (n.market || 'both')
      })).sort((a,b)=> new Date(a.date) - new Date(b.date));
      state.news = list;
      state.newsMap.clear();
      for(const n of list){
        const dayTs = normDay(new Date(n.date).getTime());
        const arr = state.newsMap.get(dayTs) || [];
        arr.push(n);
        state.newsMap.set(dayTs, arr);
      }
    }

    // ===== Ï∞®Ìä∏ =====
    function makePriceChart(ctx){
      return new Chart(ctx,{
        type:'candlestick',
        data:{datasets:[{label:'Price',data:[],yAxisID:'y',color:{up:CANDLE_UP,down:CANDLE_DOWN,unchanged:'#9aa0a6'}}]},
        options:{
          animation:false,responsive:true,maintainAspectRatio:false,parsing:false,
          scales:{
            x:{type:'time',time:{unit:'day',tooltipFormat:'yyyy-MM-dd'},grid:{color:'rgba(255,255,255,.06)'},ticks:{color:'#9aa0a6'}},
            y:{position:'left',grid:{color:'rgba(255,255,255,.06)'},ticks:{color:'#9aa0a6'}}
          },
          plugins:{legend:{display:false},tooltip:{intersect:false,mode:'index'}}
        }
      });
    }
    function makeVolChart(ctx){
      return new Chart(ctx,{
        type:'bar',
        data:{datasets:[{label:'Volume',data:[],yAxisID:'y',backgroundColor:[],barPercentage:0.92,categoryPercentage:0.92}]},
        options:{
          animation:false,responsive:true,maintainAspectRatio:false,parsing:false,
          scales:{
            x:{type:'time',time:{unit:'day',tooltipFormat:'yyyy-MM-dd'},grid:{display:false},ticks:{display:false}},
            y:{position:'left',beginAtZero:true,grid:{color:'rgba(255,255,255,.06)'},ticks:{color:'#9aa0a6'}}
          },
          plugins:{legend:{display:false},tooltip:{intersect:false,mode:'index'}}
        }
      });
    }

    function redrawCharts(){
      const upto = state.dates.slice(0, state.idx+1);
      const winDates = upto.slice(-WINDOW_DAYS);

      ['btc','xrp'].forEach(sym=>{
        const p = state.charts[sym].price;
        const v = state.charts[sym].vol;

        const priceSeries = winDates.map(day=>{
          const x = findByDate(state.data[sym], day);
          return x ? { x:x.ts, o:x.o, h:x.h, l:x.l, c:x.c } : null;
        }).filter(Boolean);

        const volSeries = winDates.map(day=>{
          const x = findByDate(state.data[sym], day);
          return x ? { x:x.ts, y:x.v, o:x.o, c:x.c } : null;
        }).filter(Boolean);
        const volColors = volSeries.map(d => (d.c >= d.o) ? VOL_UP : VOL_DOWN);

        p.data.datasets[0].data = priceSeries;
        v.data.datasets[0].data = volSeries.map(d=>({ x:d.x, y:d.y * VOL_SCALE }));
        v.data.datasets[0].backgroundColor = volColors;

        p.update('none'); v.update('none');
      });

      const firstTs = (state.idx>=0 && winDates.length) ? winDates[0] : state.dates[0];
      const lastTs  = state.dates[state.idx];
      if(firstTs && lastTs){
        document.getElementById('btcRange').textContent = `ÏùºÎ¥â(${kstDateOnly(firstTs)} ~ ${kstDateOnly(lastTs)})`;
        document.getElementById('xrpRange').textContent = `ÏùºÎ¥â(${kstDateOnly(firstTs)} ~ ${kstDateOnly(lastTs)})`;
      }
    }

    // ===== Ìó§Îçî/Î≥¥Ïú†/ÏßÑÌñâ =====
    function updateHeader(){
      ['btc','xrp'].forEach(sym=>{
        const i=state.idx, day=state.dates[i], bar=findByDate(state.data[sym], day); if(!bar) return;
        state.prevPrice[sym]=state.price[sym]; state.price[sym]=bar.c;
        const priceEl=document.getElementById(sym==='btc'?'btcPrice':'xrpPrice');
        const chgEl  =document.getElementById(sym==='btc'?'btcChange':'xrpChange');
        priceEl.textContent = `${Math.round(bar.c).toLocaleString()} KRW`;
        const prevBar = i>0 ? findByDate(state.data[sym], state.dates[i-1]) : null; const prev = prevBar ? prevBar.c : bar.c;
        const diff = bar.c - prev; const pct = prev ? (diff/prev*100) : 0;
        chgEl.textContent = `${diff>=0?'+':''}${Math.round(diff).toLocaleString()} (${pct.toFixed(2)}%)`;
        chgEl.className = diff>=0 ? 'sub positive' : 'sub negative';
      });
      document.getElementById('timebox').textContent = `ÏãúÎÆ¨Î†àÏù¥ÏÖò ÏùºÏûê: ${kstDateOnly(state.dates[state.idx])}`;
      document.getElementById('price').value = Math.round(state.price[state.activeAsset]||0).toLocaleString();
      calcTotal();
    }
    function updatePortfolioBox(){
      const krw = Math.floor(state.portfolio.krw + EPS);
      const pvBTC = state.portfolio.btc.qty * (state.price.btc||0);
      const pvXRP = state.portfolio.xrp.qty * (state.price.xrp||0);
      const total = Math.floor(krw + pvBTC + pvXRP + EPS);
      const pr = ((total - INITIAL_KRW)/INITIAL_KRW)*100;

      document.getElementById('krwBalance').textContent = krw.toLocaleString();
      document.getElementById('totalAssets').textContent = total.toLocaleString();
      const prEl=document.getElementById('profitRate'); prEl.textContent=`${pr.toFixed(2)}%`; prEl.className=`b-value ${pr>=0?'positive':'negative'}`;
      document.getElementById('holdKrw').textContent = `${krw.toLocaleString()} Ïõê`;

      const btcAvg = state.portfolio.btc.qty>EPS ? (state.portfolio.btc.cost/state.portfolio.btc.qty) : 0;
      const btcPnL = state.portfolio.btc.qty*(state.price.btc||0) - state.portfolio.btc.cost;
      document.getElementById('holdBTCQty').textContent = state.portfolio.btc.qty.toFixed(DECIMALS.btc);
      document.getElementById('holdBTCAvg').textContent = Math.floor(btcAvg).toLocaleString();
      const btcPnLEl=document.getElementById('holdBTCPnL'); btcPnLEl.textContent=`${btcPnL>=0?'+':''}${Math.floor(btcPnL).toLocaleString()} Ïõê`; btcPnLEl.className = btcPnL>=0?'positive':'negative';

      const xrpAvg = state.portfolio.xrp.qty>EPS ? (state.portfolio.xrp.cost/state.portfolio.xrp.qty) : 0;
      const xrpPnL = state.portfolio.xrp.qty*(state.price.xrp||0) - state.portfolio.xrp.cost;
      document.getElementById('holdXRPQty').textContent = state.portfolio.xrp.qty.toFixed(DECIMALS.xrp);
      document.getElementById('holdXRPAvg').textContent = Math.floor(xrpAvg).toLocaleString();
      const xrpPnLEl=document.getElementById('holdXRPPnL'); xrpPnLEl.textContent=`${xrpPnL>=0?'+':''}${Math.floor(xrpPnL).toLocaleString()} Ïõê`; xrpPnLEl.className = xrpPnL>=0?'positive':'negative';
    }

    function setSimStatus(text){ document.getElementById('simStatus').textContent = text; }
    function updateCounter(){ document.getElementById('simCounter').textContent = `${state.idx+1} / ${state.dates.length} Ïùº`; }

    function updateTick(){
      updateHeader();
      updatePortfolioBox();
      redrawCharts();
      updateCounter();
    }

    // ===== Ï£ºÎ¨∏ =====
    function setActiveAsset(asset){
      state.activeAsset = asset;
      document.getElementById('badgeBTC').classList.toggle('active', asset==='btc');
      document.getElementById('badgeXRP').classList.toggle('active', asset==='xrp');
      document.getElementById('tabBTC').classList.toggle('active', asset==='btc');
      document.getElementById('tabXRP').classList.toggle('active', asset==='xrp');
      document.getElementById('price').value = Math.round(state.price[asset]||0).toLocaleString();
      const buy = document.getElementById('side').value==='buy';
      document.getElementById('orderBtn').textContent = buy ? 'Îß§Ïàò' : 'Îß§ÎèÑ';
      document.getElementById('amount').value='';
      document.getElementById('total').value='0';
      document.getElementById('pctInput').value='';
      calcTotal();
    }
    function calcTotal(){
      const amount = parseFloat(document.getElementById('amount').value || '0');
      const px = state.price[state.activeAsset] || 0;
      const total = amount * px;
      document.getElementById('total').value = (amount>0 && px>0) ? String(total) : '0';
    }
    function buyAmountForBudget(budget, px, d){
      if(px<=0) return 0;
      return floorToDecimals(budget/px, d);
    }
    function applyPercent(pct, target='main'){
      const pct01 = Math.max(0, Math.min(100, pct)) / 100;

      if(target==='main'){
        const side=document.getElementById('side').value;
        const asset=state.activeAsset;
        const px=state.price[asset]||0; const d=DECIMALS[asset];
        if(side==='buy'){
          const budget = (pct===100) ? Math.max(0, state.portfolio.krw - 1) : state.portfolio.krw * pct01;
          document.getElementById('amount').value = buyAmountForBudget(budget, px, d);
        }else{
          const lot = state.portfolio[asset].qty * pct01;
          document.getElementById('amount').value = floorToDecimals(lot, d);
        }
        calcTotal();
      }else{
        // Îâ¥Ïä§ Î™®Îã¨
        const side = document.getElementById('newsSide').value;
        const asset=(document.getElementById('newsTabBTC').classList.contains('active')?'btc':'xrp');
        const px=state.price[asset]||0; const d=DECIMALS[asset];

        if(!side){ return; }

        if(side==='buy'){
          const budget = (pct===100) ? Math.max(0, state.portfolio.krw - 1) : state.portfolio.krw * pct01;
          document.getElementById('newsAmount').value = buyAmountForBudget(budget, px, d);
        }else if(side==='sell'){
          const qty = state.portfolio[asset].qty * pct01;
          document.getElementById('newsAmount').value = floorToDecimals(qty, d);
        }
        calcNewsTotal();
      }
    }
    function warn(msg){
      const w=document.getElementById('warn');
      if(msg && msg.trim()){ w.textContent=msg; w.classList.add('show'); }
      else{ w.textContent=''; w.classList.remove('show'); }
    }
    function placeOrder(sideOverride=null, assetOverride=null, amountOverride=null){
      warn('');
      const sym = assetOverride || state.activeAsset;
      const side = sideOverride || document.getElementById('side').value;
      const px = state.price[sym] || 0;
      let amount = (amountOverride!==null && amountOverride!==undefined)
          ? parseFloat(amountOverride)
          : parseFloat(document.getElementById('amount').value||'0');
      if(amount<=0 || px<=0){ warn('ÏàòÎüâ/Í∞ÄÍ≤©Ïù¥ Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.'); return false; }
      const total=amount*px;
      if(side==='buy'){
        if(total > state.portfolio.krw + EPS){ warn('Î≥¥Ïú† KRWÍ∞Ä Î∂ÄÏ°±Ìï©ÎãàÎã§.'); return false; }
        state.portfolio.krw = Math.max(0, state.portfolio.krw - total);
        const a=state.portfolio[sym]; a.cost += total; a.qty += amount;
      }else{
        const a=state.portfolio[sym];
        if(amount > a.qty + EPS){ warn(`${sym.toUpperCase()} Î≥¥Ïú† ÏàòÎüâÏù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§.`); return false; }
        const avg = a.qty>EPS ? (a.cost/a.qty) : 0;
        const costOut = avg * amount;
        a.qty = Math.max(0, a.qty - amount);
        a.cost = Math.max(0, a.cost - costOut);
        state.portfolio.krw += total;
      }
      document.getElementById('amount').value=''; document.getElementById('pctInput').value='';
      calcTotal(); updatePortfolioBox();
      return true;
    }

    // ===== ÌÉÄÏûÑÎùºÏù∏ =====
    function addTimelineNews(n){
      const wrap = document.getElementById('newsTimeline'); if(!wrap) return;
      const onlyDate = kstDateOnly(new Date(n.date).getTime());
      const item = document.createElement('div');
      item.className='news-item';
      item.innerHTML = `
        <div class="news-time">${onlyDate} ¬∑ ${(n.asset||'both').toUpperCase()}</div>
        <div class="news-title">${n.headline || 'ÏãúÏû• ÏÜåÏãù'}</div>
      `;
      wrap.prepend(item);
    }

    // ===== Îâ¥Ïä§ Î™®Îã¨ =====
    function setNewsAsset(asset){
      const btcTab = document.getElementById('newsTabBTC');
      const xrpTab = document.getElementById('newsTabXRP');
      btcTab.classList.toggle('active', asset==='btc');
      xrpTab.classList.toggle('active', asset==='xrp');
      const px = state.price[asset] || 0;
      document.getElementById('newsPrice').value = px ? Math.round(px).toLocaleString() : '-';
      calcNewsTotal();
    }
    function getNewsAsset(){
      return document.getElementById('newsTabBTC').classList.contains('active') ? 'btc' : 'xrp';
    }
    function calcNewsTotal(){
      const asset = getNewsAsset();
      const amount = parseFloat(document.getElementById('newsAmount').value || '0');
      const px = state.price[asset] || 0;
      const total = amount * px;
      document.getElementById('newsTotal').value = (amount>0 && px>0) ? String(total) : '0';
    }
    function resetNewsInputs(){
      document.getElementById('newsAmount').value='';
      document.getElementById('newsTotal').value='0';
      document.getElementById('newsPctInput').value='';
    }
    function wireNewsModalBasics(){
      document.getElementById('newsTabBTC').onclick = ()=>setNewsAsset('btc');
      document.getElementById('newsTabXRP').onclick = ()=>setNewsAsset('xrp');

      const sideSel = document.getElementById('newsSide');
      const confirmBtn = document.getElementById('newsConfirmBtn');
      sideSel.addEventListener('change', ()=>{
        resetNewsInputs();
        confirmBtn.disabled = !sideSel.value;
      });

      document.getElementById('newsAmount').oninput = calcNewsTotal;
      document.querySelectorAll('[data-news-pct]').forEach(btn=>{
        btn.onclick = ()=>applyPercent(parseInt(btn.dataset.newsPct,10),'news');
      });
      document.getElementById('newsPctInput').oninput = (e)=>{
        const v = Math.max(0, Math.min(100, parseFloat(e.target.value||'0'))); applyPercent(v,'news');
      };
    }
    function closeNewsModal(){ document.getElementById('newsModal').style.display = 'none'; }
    function openNewsModal(n){
      // Îâ¥Ïä§ Îú®Î©¥ ÏãúÎÆ¨Î†àÏù¥ÏÖò Ï†ïÏßÄ
      pause();

      const key = `${normDay(new Date(n.date))}:${n.headline||n.title}`;
      if(!state.newsShown.has(key)){ state.newsShown.add(key); addTimelineNews(n); }

      document.getElementById('newsHeadline').textContent = n.headline || n.title || 'ÏãúÏû• ÏÜåÏãù';
      document.getElementById('newsBody').innerHTML = (n.body || n.text || '').replace(/\n/g,'<br/>');

      document.getElementById('newsSide').value = '';
      document.getElementById('newsConfirmBtn').disabled = true;
      resetNewsInputs();
      setNewsAsset((n.asset==='btc'||n.asset==='xrp')? n.asset : 'btc');

      document.getElementById('newsConfirmBtn').onclick = ()=>{
        const side = document.getElementById('newsSide').value;
        if(!side) return;
        const asset = getNewsAsset();
        const d = DECIMALS[asset];
        const px = state.price[asset]||0;

        let amount = parseFloat(document.getElementById('newsAmount').value||'0');
        const pctVal = parseFloat(document.getElementById('newsPctInput').value||'');

        if(side==='sell'){
          if((isNaN(amount) || amount<=0) && !isNaN(pctVal)){
            amount = floorToDecimals(state.portfolio[asset].qty * Math.max(0,Math.min(100,pctVal))/100, d);
          }
          if(amount<=0) amount = floorToDecimals(state.portfolio[asset].qty, d);
        }else if(side==='buy'){
          if((isNaN(amount) || amount<=0) && !isNaN(pctVal)){
            const budget = (pctVal>=100) ? Math.max(0, state.portfolio.krw - 1) : state.portfolio.krw * (Math.max(0,Math.min(100,pctVal))/100);
            amount = buyAmountForBudget(budget, px, d);
          }
        }else{ // hold
          closeNewsModal(); return;
        }

        if(amount<=0){ alert('ÏàòÎüâ ÎòêÎäî %Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.'); return; }

        const ok = placeOrder(side, asset, amount);
        if(ok){
          setActiveAsset(asset);
          document.getElementById('side').value = side;
          document.getElementById('orderBtn').textContent = (side==='buy'?'Îß§Ïàò':'Îß§ÎèÑ');
          updateTick();
          closeNewsModal();
        }
      };

      document.getElementById('newsCloseBtn').onclick = closeNewsModal;
      document.getElementById('newsModal').style.display = 'flex';
    }

    function maybeShowNewsForToday(){
      const dayTs = state.dates[state.idx];
      const items = state.newsMap.get(dayTs) || [];
      for(const n of items){
        const k = `${normDay(new Date(n.date))}:${n.headline||n.title}`;
        if(!state.newsShown.has(k)){ openNewsModal(n); break; }
      }
    }

    // ===== Ïû¨ÏÉù/Ï†ïÏßÄ/ÌÉÄÏù¥Î®∏ =====
    function startTimer(){
      if(state.timer) clearInterval(state.timer);
      const base = 1500;                   // ÏõêÎûò Î°úÏßÅ Ïú†ÏßÄ
      const delay = Math.max(80, base / state.speed);
      state.timer = setInterval(tickStep, delay);
    }
    function play(){
      if(state.idx < state.dates.length-1){
        state.running=true;
        setSimStatus('ÏãúÎÆ¨Î†àÏù¥ÏÖò ÏßÑÌñâÏ§ë');
        startTimer();
        document.getElementById('playBtn').classList.add('is-active');
        document.getElementById('pauseBtn').classList.remove('is-active');
      }
    }
    function pause(){
      state.running=false;
      setSimStatus('ÏãúÎÆ¨Î†àÏù¥ÏÖò ÏùºÏãúÏ†ïÏßÄ');
      if(state.timer){clearInterval(state.timer); state.timer=null;}
      document.getElementById('pauseBtn').classList.add('is-active');
      document.getElementById('playBtn').classList.remove('is-active');
    }
    function resetSim(){
      pause();
      state.idx=0;
      state.portfolio = { krw:INITIAL_KRW, btc:{qty:0, cost:0}, xrp:{qty:0, cost:0} };
      state.newsShown.clear();
      const tl=document.getElementById('newsTimeline'); if(tl) tl.innerHTML='';
      setSimStatus('ÏãúÎÆ¨Î†àÏù¥ÏÖò ÎåÄÍ∏∞Ï§ë');
      updateTick();
    }
    function tickStep(){
      if(state.idx >= state.dates.length-1){
        pause();               // ÏõêÎûò Ï¢ÖÎ£åÎèôÏûë
        openSummary();         // (Ï∂îÍ∞Ä) Ï¢ÖÎ£å Ïãú Í≤∞Í≥º ÏöîÏïΩ Ïò§Ìîà
        return;
      }
      state.idx++;
      updateTick();
      maybeShowNewsForToday();
    }

    // ===== ÌÉÄÏûÑÎùºÏù∏ Î™®Îã¨ =====
    function openTimeline(){ document.getElementById('timelineModal').style.display = 'flex'; }
    function closeTimeline(){ document.getElementById('timelineModal').style.display = 'none'; }

    // ===== (Ï∂îÍ∞Ä) dd.html Î™®Îã¨ Î°úÏßÅ =====
    function openNotice(){ document.getElementById('noticeModal').style.display = 'flex'; }
    function closeNotice(){ document.getElementById('noticeModal').style.display = 'none'; }

    function openSummary(){
      const first = state.dates[0], last = state.dates[state.dates.length-1];
      const krw = Math.floor(state.portfolio.krw);
      const pvBTC = state.portfolio.btc.qty * (state.price.btc||0);
      const pvXRP = state.portfolio.xrp.qty * (state.price.xrp||0);
      const total = Math.floor(krw + pvBTC + pvXRP);
      const pr = ((total - INITIAL_KRW)/INITIAL_KRW)*100;

      const btcAvg = state.portfolio.btc.qty>0 ? (state.portfolio.btc.cost/state.portfolio.btc.qty):0;
      const btcPnL = state.portfolio.btc.qty*(state.price.btc||0) - state.portfolio.btc.cost;
      const xrpAvg = state.portfolio.xrp.qty>0 ? (state.portfolio.xrp.cost/state.portfolio.xrp.qty):0;
      const xrpPnL = state.portfolio.xrp.qty*(state.price.xrp||0) - state.portfolio.xrp.cost;

      document.getElementById('sumRange').textContent = `${kstDateOnly(first)} ~ ${kstDateOnly(last)}`;
      document.getElementById('sumTotal').textContent = total.toLocaleString();
      document.getElementById('sumPr').textContent = `${pr.toFixed(2)}%`;
      document.getElementById('sumKrw').textContent = `${krw.toLocaleString()} Ïõê`;

      document.getElementById('sumBTCQty').textContent = state.portfolio.btc.qty.toFixed(DECIMALS.btc);
      document.getElementById('sumBTCAvg').textContent = Math.floor(btcAvg).toLocaleString();
      const btcPnLEl = document.getElementById('sumBTCPnL');
      btcPnLEl.textContent = `${btcPnL>=0?'+':''}${Math.floor(btcPnL).toLocaleString()} Ïõê`;
      btcPnLEl.className = btcPnL>=0?'positive':'negative';

      document.getElementById('sumXRPQty').textContent = state.portfolio.xrp.qty.toFixed(DECIMALS.xrp);
      document.getElementById('sumXRPAvg').textContent = Math.floor(xrpAvg).toLocaleString();
      const xrpPnLEl = document.getElementById('sumXRPPnL');
      xrpPnLEl.textContent = `${xrpPnL>=0?'+':''}${Math.floor(xrpPnL).toLocaleString()} Ïõê`;
      xrpPnLEl.className = xrpPnL>=0?'positive':'negative';

      document.getElementById('summaryModal').style.display = 'flex';
    }
    function closeSummary(){ document.getElementById('summaryModal').style.display = 'none'; }

    // ===== Ïù¥Î≤§Ìä∏ =====
    function wireEvents(){
      document.getElementById('leftCol').addEventListener('click', ()=>setActiveAsset('btc'));
      document.getElementById('rightCol').addEventListener('click', ()=>setActiveAsset('xrp'));
      document.getElementById('tabBTC').addEventListener('click', ()=>setActiveAsset('btc'));
      document.getElementById('tabXRP').addEventListener('click', ()=>setActiveAsset('xrp'));

      document.getElementById('newsToggle').addEventListener('click', openTimeline);
      document.getElementById('timelineClose').addEventListener('click', closeTimeline);
      document.getElementById('timelineClose2').addEventListener('click', closeTimeline);

      // Î©îÏù∏ Ï£ºÎ¨∏Íµ¨Î∂Ñ Î≥ÄÍ≤Ω Ïãú Ï¥àÍ∏∞Ìôî
      document.getElementById('side').addEventListener('change',()=>{
        const buy = document.getElementById('side').value==='buy';
        document.getElementById('orderBtn').textContent = buy ? 'Îß§Ïàò' : 'Îß§ÎèÑ';
        document.getElementById('amount').value='';
        document.getElementById('total').value='0';
        document.getElementById('pctInput').value='';
        calcTotal();
      });

      document.getElementById('amount').addEventListener('input',calcTotal);
      document.getElementById('pctInput').addEventListener('input',e=>{
        const v = Math.max(0, Math.min(100, parseFloat(e.target.value||'0'))); applyPercent(v,'main');
      });
      document.querySelectorAll('.pct').forEach(b=>{
        if(b.hasAttribute('data-pct')) b.addEventListener('click',()=>applyPercent(parseInt(b.dataset.pct,10),'main'));
      });
      document.getElementById('orderBtn').addEventListener('click',()=>{
        const ok = placeOrder();
        if(!ok) return;
        updateTick();
      });

      document.getElementById('playBtn').addEventListener('click',play);
      document.getElementById('pauseBtn').addEventListener('click',pause);
      document.getElementById('resetBtn').addEventListener('click',resetSim);

      const speedEl=document.getElementById('speedSlider'), speedVal=document.getElementById('speedVal');
      speedEl.addEventListener('input', e=>{
        state.speed = Math.max(1, parseInt(e.target.value,10)||1);
        speedVal.textContent = `${state.speed}x`;
        if(state.running){ startTimer(); }
      });

      wireNewsModalBasics();

      // (Ï∂îÍ∞Ä) üìñ Î≤ÑÌäº: ÏïàÎÇ¥ Î™®Îã¨ Ïó¥Í∏∞
      document.getElementById('helpBtn').addEventListener('click', openNotice);
      document.getElementById('noticeOkBtn').addEventListener('click', closeNotice);

      // (Ï∂îÍ∞Ä) ÏöîÏïΩ Î™®Îã¨ Î≤ÑÌäº
      document.getElementById('summaryCloseBtn').addEventListener('click', closeSummary);
      document.getElementById('summaryOkBtn').addEventListener('click', closeSummary);
      document.getElementById('summaryResetBtn').addEventListener('click', ()=>{
        closeSummary();
        resetSim();
      });
    }

    // ===== Ï¥àÍ∏∞Ìôî =====
    async function init(){
      try{
        document.getElementById('btcRange').textContent = `ÏùºÎ¥â(${RANGE.start} ~ ${RANGE.end})`;
        document.getElementById('xrpRange').textContent = `ÏùºÎ¥â(${RANGE.start} ~ ${RANGE.end})`;

        const [btc, xrp] = await Promise.all([fetchDaily('btc'), fetchDaily('xrp')]);
        await fetchNews();

        state.data.btc = btc; state.data.xrp = xrp;

        const btcDays = new Set(btc.map(d=>normDay(d.ts)));
        const xrpDays = new Set(xrp.map(d=>normDay(d.ts)));
        const common = [...btcDays].filter(x=>xrpDays.has(x)).sort((a,b)=>a-b);
        if(!common.length) throw new Error('Í≥µÌÜµ ÏùºÏûêÍ∞Ä ÏóÜÏäµÎãàÎã§.');
        state.dates = common;

        // Ï∞®Ìä∏ ÏÉùÏÑ±
        state.charts.btc.price = makePriceChart(document.getElementById('btcPriceChart').getContext('2d'));
        state.charts.btc.vol   = makeVolChart  (document.getElementById('btcVolChart').getContext('2d'));
        state.charts.xrp.price = makePriceChart(document.getElementById('xrpPriceChart').getContext('2d'));
        state.charts.xrp.vol   = makeVolChart  (document.getElementById('xrpVolChart').getContext('2d'));

        document.getElementById('newsTimeline').innerHTML = '';

        setSimStatus('ÏãúÎÆ¨Î†àÏù¥ÏÖò ÎåÄÍ∏∞Ï§ë');
        updateCounter();

        redrawCharts(); updateTick(); wireEvents();

        // (Ï∂îÍ∞Ä) ÌéòÏù¥ÏßÄ ÏßÑÏûÖ Ïãú ÌäúÌÜ†Î¶¨Ïñº ÌåùÏóÖ ÏûêÎèô ÌëúÏãú
        openNotice();
      }catch(e){
        console.error(e); alert(e.message || 'Î°úÎî© Ïò§Î•ò');
      }
    }
    init();
  </script>
</body>
</html>

