<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Q&A 상세 | ITC</title>
  <style>
    :root{
      color-scheme: dark;
      --bg:#1a1a1a; --txt:#e8e8e8;
      --card-bg:#242424; --border:#3a3a3a; --muted:#9aa0a6;
      --pill-bg:#111; --pill-border:#2a2a2a; --accent:#4f7cff;
      --upvote:#4d4d4d;        /* 기본(미투표) */
      --upvote-hover:#868686;
      --upvote-on:#0f163b;     /* 투표 완료 */
      --upvote-on-border:#14534d;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; background:var(--bg); color:var(--txt);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; }
    header{ position:fixed; inset:16px 16px auto 16px; z-index:10; display:flex; align-items:center; justify-content:space-between; }
    .brand img{ width:120px; height:auto; display:block; user-select:none; -webkit-user-drag:none; filter:drop-shadow(0 6px 18px rgba(0,0,0,.35)); }
    .navbtn{ display:inline-flex; align-items:center; gap:10px; height:38px; padding:0 12px; border-radius:10px; background:#121212; border:1px solid #262626; color:#e8e8e8; text-decoration:none; font-weight:700; cursor:pointer; }
    .navbtn:hover{ background:#191919; }
    main{ width:min(1000px,92vw); margin:100px auto 80px; display:flex; flex-direction:column; gap:18px; }

    .card{ background:var(--card-bg); border:1px solid var(--border); border-radius:14px; padding:18px; }
    h1{ margin:0 0 6px 0; font-size:clamp(20px,4vw,26px); font-weight:800; }
    .meta{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; font-size:13px; color:var(--muted); }
    .badge{ display:inline-flex; align-items:center; gap:6px; height:24px; padding:0 8px; border-radius:999px; border:1px solid var(--pill-border); background:var(--pill-bg); font-weight:600; font-size:12px; }
    .body{ line-height:1.7; white-space:pre-wrap; word-break:break-word; }
    .divider{ height:1px; background:var(--border); margin:14px 0; }

    /* 추천/조회 라인 */
    .stats{ display:flex; gap:10px; color:var(--muted); font-size:13px; align-items:center; flex-wrap:wrap; }
    .pill{ display:inline-flex; align-items:center; gap:8px; height:32px; padding:0 12px; border-radius:999px; border:1px solid var(--border); background:#121212; color:#e8e8e8; }
    .upvote{ display:inline-flex; align-items:center; gap:8px; height:32px; padding:0 14px; border-radius:999px; border:1px solid var(--border); background:var(--upvote); color:#e8f0ff; font-weight:800; cursor:pointer; }
    .upvote:hover{ background:var(--upvote-hover); }
    .upvote[aria-pressed="true"]{ background:var(--upvote-on); border-color:var(--upvote-on-border); }
    .upvote[disabled]{ opacity:.6; cursor:not-allowed; }

    /* 댓글 */
    .section-title{ margin:6px 0 4px; font-size:18px; font-weight:800; }
    .comment{ background:#202020; border:1px solid #303030; border-radius:12px; padding:14px; margin-top:10px; }
    .comment .who{ font-size:13px; color:var(--muted); margin-bottom:6px; display:flex; gap:8px; align-items:center; }
    .comment .body{ white-space:pre-wrap; word-break:break-word; line-height:1.7; }
    .form-grid{ display:grid; gap:10px; margin-top:10px; }
    textarea, input{ width:100%; border-radius:10px; border:1px solid #555; background:#1a1a1a; color:#e8e8e8; padding:10px 12px; outline:none; }
    textarea{ min-height:120px; resize:vertical; }
    .actions{ display:flex; gap:8px; justify-content:flex-end; }
    .btn{ height:40px; padding:0 14px; border-radius:10px; border:1px solid var(--border); background:#121212; color:#e8e8e8; cursor:pointer; }
    .hint{ font-size:12px; color:#b5b5b5; }
    .error{ color:#ffb3b3; font-size:13px; display:none; }
  </style>
</head>
<body>
  <header>
    <a class="brand" href="index.html"><img src="/images/logo.png" alt="ITC 로고"/></a>
    <a href="qna.html" class="navbtn">← 목록으로</a>
  </header>

  <main>
    <article class="card" id="qWrap">
      <div class="top">
        <h1 id="qTitle">제목 로딩중…</h1>
        <div class="meta" id="qMeta"></div>
      </div>
      <div class="divider"></div>
      <div class="body" id="qBody">내용 로딩중…</div>
      <div class="divider"></div>

      <!-- 추천(버튼+숫자, 토글 색상) + 조회 -->
      <div class="stats">
        <button id="btnUpvote" class="upvote" type="button" aria-pressed="false" aria-label="이 질문 추천하기">
          추천 <span id="qVotes">0</span>
        </button>
        <span class="pill">조회 <strong id="qViews">0</strong></span>
      </div>
    </article>

    <section class="card" id="qCommentsSection">
      <div class="section-title">댓글</div>
      <div id="qCommentsList"></div>
      <div class="divider"></div>
      <div class="form-grid">
        <textarea id="qCommentBody" placeholder="댓글을 입력하세요"></textarea>
        <div class="actions">
          <button class="btn" id="qCommentSubmit" type="button">댓글 등록</button>
        </div>
        <div class="hint">* 댓글 작성은 로그인 필요. 비공개 질문은 작성자/관리자만 볼 수 있습니다.</div>
        <div class="error" id="qComErr"></div>
      </div>
    </section>
  </main>

  <script>
    const $ = (s, el=document)=>el.querySelector(s);
    const escapeHtml = (s='')=>String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
    const fmtDate = iso => { const d = new Date(iso); return isNaN(d)?'':d.toLocaleString('ko-KR',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}); };

    // id 확보(없으면 목록으로)
    const params = new URLSearchParams(location.search);
    const qid = Number(params.get('id') || '');
    if(!qid){ location.replace('qna.html'); }

    async function fetchJSON(url, opt){
      const res = await fetch(url, opt);
      let out=null; try{ out = await res.json(); }catch{}
      if(!res.ok){ throw new Error(out?.error || (res.status+' error')); }
      return out ?? {};
    }

    // 카테고리
    let CATS=null;
    async function loadCats(){
      if(CATS) return CATS;
      try{ const res = await fetch('/api/qna/categories'); CATS = res.ok? await res.json():[]; }
      catch{ CATS=[]; }
      return CATS;
    }
    async function categoryLabel(id){
      const cats = await loadCats();
      return (cats.find(c=>String(c.id)===String(id))||{}).label || String(id);
    }

    // 상세
    async function loadQuestion(){
      const q = await fetchJSON(`/api/qna/questions/${qid}`);
      $('#qTitle').textContent = q.title;
      $('#qBody').textContent  = q.body || '';
      const visBadge = `<span class="badge">${q.visibility==='private'?'비공개':'공개'}</span>`;
      const cat = await categoryLabel(q.category_id);
      $('#qMeta').innerHTML = `
        <span class="badge">${escapeHtml(cat)}</span>
        ${visBadge}
        <span>작성자 ${escapeHtml(q.author_name || q.author_email || 'user')}</span>
        <span>· ${fmtDate(q.created_at)}</span>
      `;
      $('#qVotes').textContent = Number(q.upvotes||0);
      $('#qViews').textContent = Number(q.views||0).toLocaleString('ko-KR');
    }

    // 내 투표 여부 확인 → 버튼 상태
    async function loadVoteState(){
      try{
        const s = await fetchJSON(`/api/qna/questions/${qid}/upvote-state`);
        const voted = !!s?.voted;
        $('#btnUpvote').setAttribute('aria-pressed', String(voted));
      }catch{ /* 비로그인/엔드포인트부재 등은 무시 */ }
    }

    // 추천 (계정당 1회, 서버 강제)
    async function upvote(btn){
      if(btn.getAttribute('aria-pressed') === 'true') return; // 이미 투표
      btn.disabled = true;
      try{
        const out = await fetchJSON(`/api/qna/questions/${qid}/upvote`, { method:'POST' });
        const newVotes = Number(out?.upvotes ?? out?.count ?? 0);
        if(!Number.isNaN(newVotes)) $('#qVotes').textContent = newVotes;
        btn.setAttribute('aria-pressed','true');
      }catch(e){
        // 409 = 이미 투표함 / 401 = 로그인 필요
        alert(e.message || '추천 실패');
      }finally{ btn.disabled = false; }
    }

    // 댓글 목록/등록
    async function loadComments(question_id){
      const list = await fetchJSON(`/api/qna/comments?question_id=${question_id}`);
      const wrap = document.getElementById('qCommentsList');
      wrap.innerHTML = '';
      if(!list.length){ wrap.innerHTML = `<div class="hint">댓글이 없습니다.</div>`; return; }
      const byParent = new Map();
      for(const c of list){
        const key = c.parent_comment_id || 0;
        if(!byParent.has(key)) byParent.set(key, []);
        byParent.get(key).push(c);
      }
      const render = (pid, depth=0)=>{
        (byParent.get(pid)||[]).forEach(c=>{
          const el = document.createElement('div');
          el.className='comment';
          el.style.marginLeft = (depth*16)+'px';
          el.innerHTML = `
            <div class="who">작성자 ${escapeHtml(c.author_name || c.author_email || 'user')} · ${fmtDate(c.created_at)}${c.parent_comment_id ? ' · 대댓글' : ''}</div>
            <div class="body">${escapeHtml(c.body||'')}</div>
          `;
          wrap.appendChild(el);
          render(c.id, depth+1);
        });
      };
      render(0, 0);
    }
    async function submitComment(question_id, parent_comment_id, body){
      const res = await fetch('/api/qna/comments', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ question_id, parent_comment_id: parent_comment_id || null, body })
      });
      let out=null; try{ out=await res.json(); }catch{}
      if(!res.ok) throw new Error(out?.error || '댓글 등록 실패');
      return out;
    }

    document.addEventListener('click', async (e)=>{
      if(e.target.id==='btnUpvote') await upvote(e.target);
      if(e.target.id==='qCommentSubmit'){
        const body = $('#qCommentBody').value.trim();
        const err = $('#qComErr');
        if(!body){ err.style.display='block'; err.textContent='댓글 내용을 입력하세요.'; return; }
        err.style.display='none';
        try{ await submitComment(qid, null, body); $('#qCommentBody').value=''; await loadComments(qid); }
        catch(err2){ err.style.display='block'; err.textContent = err2.message || '댓글 등록 실패'; }
      }
    });

    (async function init(){
      try{
        await loadQuestion();   // 상세(여기서 조회수 반영)
        await loadVoteState();  // 내 투표 여부
        await loadComments(qid);
      }catch(err){
        alert(err.message || '상세 조회 실패');
        if(String(err.message||'').includes('forbidden') || String(err.message||'').includes('(403)')){
          location.replace('qna.html');
        }
      }
    })();
  </script>
</body>
</html>
