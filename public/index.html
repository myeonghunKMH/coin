<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>실시간 비트코인 차트 (Node.js)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        text-align: center;
        padding: 20px;
        background-color: #121212;
        color: white;
      }
      .container {
        max-width: 900px;
        margin: auto;
        background-color: #1e1e1e;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }
      h1 {
        color: #4caf50;
      }
      #current-price {
        font-size: 2.5em;
        font-weight: bold;
        margin: 20px 0;
      }
      #chart-container {
        position: relative;
        height: 400px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>실시간 비트코인 차트</h1>
      <div id="current-price">로딩 중...</div>
      <div id="chart-container">
        <canvas id="btcChart"></canvas>
      </div>
    </div>

    <script>
      const ctx = document.getElementById("btcChart").getContext("2d");
      const CHART_HISTORY_LIMIT = 50;
      let btcChart;

      const chartData = {
        labels: [],
        datasets: [
          {
            label: "BTC/KRW 가격",
            data: [],
            borderColor: "rgb(75, 192, 192)",
            tension: 0.1,
            fill: false,
          },
        ],
      };

      const chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        animation: {
          duration: 0,
        },
        scales: {
          x: {
            title: {
              display: true,
              text: "시간",
              color: "white",
            },
            grid: {
              color: "rgba(255, 255, 255, 0.1)",
            },
            ticks: {
              color: "white",
            },
          },
          y: {
            title: {
              display: true,
              text: "가격(KRW)",
              color: "white",
            },
            grid: {
              color: "rgba(255, 255, 255, 0.1)",
            },
            ticks: {
              color: "white",
            },
          },
        },
        plugins: {
          legend: {
            labels: {
              color: "white",
            },
          },
          tooltip: {
            backgroundColor: "rgba(0, 0, 0, 0.7)",
          },
        },
      };

      btcChart = new Chart(ctx, {
        type: "line",
        data: chartData,
        options: chartOptions,
      });

      // 로컬 웹소켓 서버에 연결
      const ws = new WebSocket("ws://localhost:3000");

      ws.onopen = () => {
        console.log("로컬 웹소켓 서버에 연결되었습니다.");
      };

      ws.onmessage = (event) => {
        // 데이터가 Blob 객체인지 확인
        if (event.data instanceof Blob) {
          const reader = new FileReader();
          reader.onload = () => {
            try {
              const upbitData = JSON.parse(reader.result);
              if (upbitData.trade_price) {
                // 차트 및 가격 업데이트 로직
                const now = new Date(upbitData.trade_timestamp);
                const timeString = now.toLocaleTimeString();

                document.getElementById(
                  "current-price"
                ).innerText = `현재가: ${upbitData.trade_price.toLocaleString()} KRW`;

                chartData.labels.push(timeString);
                chartData.datasets[0].data.push(upbitData.trade_price);

                if (chartData.labels.length > CHART_HISTORY_LIMIT) {
                  chartData.labels.shift();
                  chartData.datasets[0].data.shift();
                }

                btcChart.update();
              }
            } catch (e) {
              console.error("웹소켓 메시지 파싱 오류:", e);
            }
          };
          reader.readAsText(event.data);
        } else {
          // 데이터가 이미 문자열인 경우 (JSON.parse가 바로 가능)
          try {
            const upbitData = JSON.parse(event.data);
            if (upbitData.trade_price) {
              // 차트 및 가격 업데이트 로직 (위와 동일)
              const now = new Date(upbitData.trade_timestamp);
              const timeString = now.toLocaleTimeString();

              document.getElementById(
                "current-price"
              ).innerText = `현재가: ${upbitData.trade_price.toLocaleString()} KRW`;

              chartData.labels.push(timeString);
              chartData.datasets[0].data.push(upbitData.trade_price);

              if (chartData.labels.length > CHART_HISTORY_LIMIT) {
                chartData.labels.shift();
                chartData.datasets[0].data.shift();
              }

              btcChart.update();
            }
          } catch (e) {
            console.error("웹소켓 메시지 파싱 오류:", e);
          }
        }
      };
    </script>
  </body>
</html>
