<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>실시간 암호화폐 모의투자 (Node.js)</title>
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1"></script>
  </head>
  <body>
    <div class="container">
      <h1>실시간 암호화폐 시세</h1>

      <div class="coin-summary" id="coin-summary"></div>

      <div class="chart-section">
        <div class="chart-controls">
          <div class="coin-tabs" id="coin-tabs"></div>
          <div class="time-tabs" id="time-tabs">
            <button class="time-tab" data-unit="5">5분</button>
            <button class="time-tab" data-unit="15">15분</button>
            <button class="time-tab active" data-unit="60">1시간</button>
            <button class="time-tab" data-unit="240">4시간</button>
            <button class="time-tab" data-unit="1D">1일</button>
          </div>
        </div>
        <canvas id="coinChart"></canvas>
      </div>
    </div>

    <script>
      const marketCodes = ["KRW-BTC", "KRW-ETH", "KRW-XRP"];
      const coinNames = {
        "KRW-BTC": "비트코인",
        "KRW-ETH": "이더리움",
        "KRW-XRP": "리플",
      };

      let latestTickerData = {};
      let activeCoin = "KRW-BTC";
      let activeUnit = "60";

      marketCodes.forEach((code) => {
        latestTickerData[code] = {
          trade_price: 0,
          change_rate: 0,
          signed_change_price: 0,
          acc_trade_price_24h: 0,
        };
      });

      const ctx = document.getElementById("coinChart").getContext("2d");
      let mainChart = null;

      async function fetchAndRenderChart() {
        if (!activeCoin || !activeUnit) return;

        try {
          const response = await fetch(
            `/api/candles?unit=${activeUnit}&market=${activeCoin}`
          );
          const data = await response.json();

          const sortedData = data.reverse();
          const chartData = sortedData.map((d) => ({
            x: new Date(d.candle_date_time_kst).getTime(),
            o: d.opening_price,
            h: d.high_price,
            l: d.low_price,
            c: d.trade_price,
          }));

          const dataset = [
            {
              label: `${coinNames[activeCoin]} ${activeUnit} 캔들`,
              data: chartData,
              borderColor: "rgb(75, 192, 192)",
              tension: 0.1,
            },
          ];

          let unitForChart;
          if (activeUnit === "1D") {
            unitForChart = "day";
          } else if (parseInt(activeUnit) >= 60) {
            unitForChart = "hour";
          } else {
            unitForChart = "minute";
          }

          const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                mode: "index",
                intersect: false,
              },
            },
            scales: {
              x: {
                type: "time",
                time: {
                  unit: unitForChart,
                  displayFormats: {
                    minute: "HH:mm",
                    hour: "HH:mm",
                    day: "MM-DD",
                  },
                },
                title: { display: true, text: "시간", color: "white" },
                grid: { color: "rgba(255, 255, 255, 0.1)" },
                ticks: { color: "white" },
              },
              y: {
                title: { display: true, text: "가격(KRW)", color: "white" },
                grid: { color: "rgba(255, 255, 255, 0.1)" },
                ticks: { color: "white" },
              },
            },
          };

          // --- 수정된 부분: 차트 인스턴스 존재 여부 확인 및 파괴 ---
          if (mainChart) {
            mainChart.destroy(); // 기존 차트 파괴
          }
          // ----------------------------------------------------

          mainChart = new Chart(ctx, {
            type: "candlestick",
            data: {
              datasets: dataset,
            },
            options: chartOptions,
          });
        } catch (error) {
          console.error("캔들 데이터 로딩 오류:", error);
        }
      }

      function updateUI(code) {
        const tabsContainer = document.getElementById("coin-tabs");
        tabsContainer.innerHTML = "";
        marketCodes.forEach((c) => {
          const tab = document.createElement("div");
          tab.className = `coin-tab ${c === activeCoin ? "active" : ""}`;
          tab.innerText = coinNames[c];
          tab.onclick = () => switchCoin(c);
          tabsContainer.appendChild(tab);
        });

        const summaryContainer = document.getElementById("coin-summary");
        const data = latestTickerData[code];
        if (data) {
          const changePriceClass =
            data.signed_change_price >= 0 ? "positive" : "negative";
          const changeRateClass =
            data.change_rate >= 0 ? "positive" : "negative";

          summaryContainer.innerHTML = `
            <div class="coin-summary-item">
              <span class="summary-label">현재가 (${coinNames[code]})</span>
              <span class="summary-value">${data.trade_price.toLocaleString()} KRW</span>
            </div>
            <div class="coin-summary-item">
              <span class="summary-label">변화액</span>
              <span class="summary-value ${changePriceClass}">${data.signed_change_price.toLocaleString()} KRW</span>
            </div>
            <div class="coin-summary-item">
              <span class="summary-label">변동률 (24H)</span>
              <span class="summary-value ${changeRateClass}">${(
            data.change_rate * 100
          ).toFixed(2)}%</span>
            </div>
            <div class="coin-summary-item">
              <span class="summary-label">거래대금 (24H)</span>
              <span class="summary-value">${Math.floor(
                data.acc_trade_price_24h
              ).toLocaleString()} KRW</span>
            </div>
          `;
        }
      }

      function switchCoin(code) {
        if (activeCoin !== code) {
          activeCoin = code;
          updateUI(activeCoin);
          fetchAndRenderChart();
        }
      }

      document.getElementById("time-tabs").addEventListener("click", (e) => {
        if (e.target.tagName === "BUTTON") {
          document
            .querySelectorAll(".time-tab")
            .forEach((btn) => btn.classList.remove("active"));
          e.target.classList.add("active");
          activeUnit = e.target.dataset.unit;
          fetchAndRenderChart();
        }
      });

      const ws = new WebSocket("ws://localhost:3000");

      ws.onmessage = (event) => {
        if (event.data instanceof Blob) {
          const reader = new FileReader();
          reader.onload = () => {
            handleWebSocketMessage(reader.result);
          };
          reader.readAsText(event.data);
        } else {
          handleWebSocketMessage(event.data);
        }
      };

      function handleWebSocketMessage(data) {
        try {
          const upbitData = JSON.parse(data);
          if (
            upbitData &&
            upbitData.code &&
            marketCodes.includes(upbitData.code) &&
            upbitData.trade_price
          ) {
            const code = upbitData.code;
            latestTickerData[code] = {
              trade_price: upbitData.trade_price,
              change_rate: upbitData.change_rate || 0,
              signed_change_price: upbitData.signed_change_price || 0,
              acc_trade_price_24h: upbitData.acc_trade_price_24h || 0,
              trade_timestamp: upbitData.trade_timestamp,
            };
            updateUI(activeCoin);
          }
        } catch (e) {
          console.error("웹소켓 메시지 파싱 오류:", e);
        }
      }

      updateUI(activeCoin);
      fetchAndRenderChart();
    </script>
  </body>
</html>
